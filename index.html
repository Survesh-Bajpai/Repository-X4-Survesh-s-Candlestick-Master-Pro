<!DOCTYPE html>
<html lang="en">
<head>
    <!-- IMPORTANT: Save this file with UTF-8 encoding from your text editor -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survesh Bajpai's Candlestick Master Pro (v.ScoreBased+TermEval)</title>
    <style>
        /* --- Base Styles & CSS Variables --- */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --section-bg: #f8f9fa;
            --text-color: #212529;
            --heading-color: #003366;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --disabled-bg: #ced4da;
            --disabled-text: #6c757d;
            --candle-border: #343a40;
            --wick-color: #343a40;
            --bullish-color: #28a745;
            --bullish-border: #1e7e34;
            --bearish-color: #dc3545;
            --bearish-border: #b02a37;
            --doji-color: #6c757d;
            --doji-border: #5a6268;
            --future-candle-opacity: 0.65;
            --feedback-correct-bg: #d4edda;
            --feedback-correct-text: #155724;
            --feedback-correct-border: #c3e6cb;
            --feedback-incorrect-bg: #f8d7da;
            --feedback-incorrect-text: #721c24;
            --feedback-incorrect-border: #f5c6cb;
            --progress-bar-bg: #e9ecef;
            --progress-bar-fill: var(--primary-color);
            --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --animation-speed: 0.25s;
        }

        /* --- Dark Theme Variables --- */
        body.dark-theme {
            --bg-color: #1a1d21; --container-bg: #2c3034; --section-bg: #212529;
            --text-color: #e9ecef; --heading-color: #cdd3da; --primary-color: #0d6efd;
            --primary-hover: #3b82f6; --secondary-color: #495057; --secondary-hover: #5c636a;
            --border-color: #495057; --shadow-color: rgba(0, 0, 0, 0.5);
            --disabled-bg: #495057; --disabled-text: #adb5bd; --candle-border: #adb5bd;
            --wick-color: #dee2e6; --bullish-color: #198754; --bullish-border: #146c43;
            --bearish-color: #dc3545; --bearish-border: #b02a37; --doji-color: #6c757d;
            --doji-border: #808890; --feedback-correct-bg: #143624; --feedback-correct-text: #7ee2a8;
            --feedback-correct-border: #1c5a39; --feedback-incorrect-bg: #4a1e27; --feedback-incorrect-text: #f5c2c7;
            --feedback-incorrect-border: #7e323a; --progress-bar-bg: #495057;
        }

        /* --- General Styles --- */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body { font-family: var(--font-sans); line-height: 1.6; padding: 15px; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; transition: background-color var(--animation-speed) ease, color var(--animation-speed) ease; overflow: hidden; user-select: none; }
        .game-container { background-color: var(--container-bg); padding: 20px 25px; border-radius: 10px; box-shadow: 0 5px 20px var(--shadow-color); width: 100%; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; transition: background-color var(--animation-speed) ease, box-shadow var(--animation-speed) ease; }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 1em; padding-bottom: 1em; border-bottom: 1px solid var(--border-color); gap: 10px; flex-shrink: 0; }
        .header-left { flex-grow: 1; min-width: 200px; }
        .header-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; flex-wrap: wrap; }
         .game-stats { display: flex; gap: 10px; font-size: 0.85em; flex-wrap: wrap; margin-bottom: 5px; }
         .game-stats span { background-color: var(--section-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); white-space: nowrap; transition: background-color var(--animation-speed) ease; }
         .game-stats .capital { font-weight: 600; color: var(--primary-color); }
         .game-stats .streak { font-weight: 600; color: #fd7e14; }
        h1 { font-size: 1.6em; line-height: 1.2; margin-bottom: 0.2em; color: var(--heading-color);}
        h2 { font-size: 1.3em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.4em; margin-bottom: 1em; color: var(--heading-color);}
        h3 { font-size: 1.05em; color: var(--primary-color); margin-bottom: 0.5em; }

        /* --- Main Layout --- */
        .main-content { display: flex; gap: 0; flex-grow: 1; overflow: hidden; }
        #learning-section { flex: 0 0 320px; display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.4s ease, opacity 0.4s ease, flex-basis 0s; flex-shrink: 0; border-right: none; min-width: 200px; position: relative; margin-right: 0; }
        #learning-section.hidden { transform: translateX(-100%); opacity: 0; flex-basis: 0 !important; padding: 0; margin: 0; border: none; min-width: 0; overflow: hidden; visibility: hidden; }
        .resizer { flex: 0 0 5px; background-color: var(--border-color); cursor: ew-resize; align-self: stretch; margin: 0 5px; border-radius: 3px; transition: background-color var(--animation-speed) ease; }
        .resizer:hover, .resizer.resizing { background-color: var(--primary-color); }
        .resizer.hidden { display: none; }
        #simulator-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 300px; }
        #simulator-section { flex-grow: 1; display: flex; flex-direction: column; margin-bottom: 0; overflow: hidden; border-left: none; }
        .game-container.real-game-mode .main-content #learning-section, .game-container.real-game-mode .main-content .resizer { display: none !important; flex-basis: 0 !important; min-width: 0 !important; margin: 0 !important; padding: 0 !important; border: none !important; }
        .game-container.real-game-mode .main-content #simulator-container { min-width: 100%; }
        .section { margin-bottom: 10px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--section-bg); transition: background-color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        #learning-section, #simulator-section { margin-bottom: 0; }

        /* Progress Bar & Level Info */
        #level-info { margin-bottom: 10px; padding: 10px 15px; position: relative;}
        .level-nav-buttons { position: absolute; top: 10px; right: 15px; display: flex; gap: 8px; }
        .level-nav-buttons button { font-size: 0.75em; padding: 3px 8px; background-color: var(--secondary-color); }
        .level-nav-buttons button:hover { background-color: var(--secondary-hover); }
        .progress-bar-container { width: 100%; height: 8px; background-color: var(--progress-bar-bg); border-radius: 4px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-color); transition: background-color var(--animation-speed) ease; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: var(--progress-bar-fill); border-radius: 4px; transition: width 0.5s ease-out; }
        #real-game-message { font-weight: bold; color: var(--primary-color); margin-top: 5px; }
        #level-progress-info { font-size: 0.8em; color: var(--text-color); opacity: 0.8; margin-top: 2px; }

        /* Theme Toggle */
        .theme-switch-wrapper { display: flex; align-items: center; font-size: 0.85em; }
        .theme-switch { display: inline-block; height: 20px; position: relative; width: 38px; margin-left: 6px; cursor: pointer; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 20px; }
        .slider:before { background-color: white; bottom: 2px; content: ""; height: 16px; left: 2px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Learning Section */
        #learning-content { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        #learning-content ul { list-style: none; padding: 0; margin: 0; }
        #learning-content li { margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; display: flex; gap: 10px; flex-wrap: nowrap; }
        #learning-content li:last-child { border-bottom: none; margin-bottom: 0; }
        .pattern-description { flex: 1; min-width: 150px; }
        #learning-content li strong { display: block; color: var(--primary-color); margin-bottom: 3px; font-size: 1.05em; }
        #learning-content li .pattern-type { font-style: italic; font-size: 0.8em; color: var(--text-color); opacity: 0.8; display: block; margin-bottom: 4px;}
        .pattern-example-chart-container { flex-shrink: 0; }
        .pattern-example-chart-container small { font-size: 0.75em; opacity: 0.7; display: block; margin-bottom: 2px;}
        .pattern-example-chart { height: 100px; width: 100px; border: 1px solid var(--border-color); background-color: var(--container-bg); position: relative; display: flex; align-items: stretch; padding: 6px 3px; overflow: hidden; border-radius: 4px; margin-top: 2px; transition: background-color var(--animation-speed) ease; }

        /* Simulator */
        #chart-container { border: 1px solid var(--border-color); background-color: var(--container-bg); position: relative; display: flex; align-items: stretch; padding: 10px 2px; overflow: hidden; border-radius: 6px; transition: all var(--animation-speed) ease; flex-grow: 1; min-height: 250px; }
        .candle-wrapper { height: 100%; flex: 1; position: relative; margin: 0 0.5%; min-width: 1px; display: flex; align-items: center; justify-content: center; }
        .wick { width: 1px; background-color: var(--wick-color); position: absolute; left: calc(50% - 0.5px); transition: background-color var(--animation-speed) ease, opacity var(--animation-speed) ease; z-index: 1; }
        .body { width: 80%; position: absolute; left: 10%; border: 1px solid var(--candle-border); background-color: white; transition: all var(--animation-speed) ease; z-index: 2; }
        .future .body, .future .wick { opacity: var(--future-candle-opacity); }
        .bullish .body { background-color: var(--bullish-color); border-color: var(--bullish-border); }
        .bearish .body { background-color: var(--bearish-color); border-color: var(--bearish-border); }
        .doji .body { background-color: var(--doji-color); border-color: var(--doji-border); }
        body.dark-theme .wick { background-color: var(--wick-color); }
        body.dark-theme .body { border: 1px solid var(--candle-border); }
        body.dark-theme .bullish .body { background-color: var(--bullish-color); }
        body.dark-theme .bearish .body { background-color: var(--bearish-color); }
        body.dark-theme .doji .body { background-color: var(--doji-color); }

        /* Simulator Controls */
        .simulator-controls { padding: 10px 0 0 0; flex-shrink: 0; }
        .input-area { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        #pattern-selection, #prediction-input, #term-prediction { flex: 1; min-width: 150px; }
        label { display: block; margin-bottom: 4px; font-weight: 500; color: var(--heading-color); font-size: 0.9em; }
        select { padding: 8px 10px; width: 100%; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--text-color); font-size: 0.9em; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23212529%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 8px top 50%; background-size: .6em auto; transition: all var(--animation-speed) ease; cursor: pointer; }
        select:disabled { cursor: not-allowed; opacity: 0.7; }
        .action-area { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;}
        button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease; flex-shrink: 0; }
        #toggle-fullscreen-btn { position: absolute; top: 8px; right: 8px; background-color: var(--secondary-color); color: white; padding: 4px 8px; font-size: 0.75em; z-index: 10; border-radius: 4px; line-height: 1; min-width: auto; width: auto; display: inline-block; }
        body.dark-theme #toggle-fullscreen-btn { background-color: var(--secondary-color); }
        #toggle-fullscreen-btn:hover { background-color: var(--secondary-hover); transform: scale(1.05); }
        #skip-to-real-game-btn, #back-to-learning-btn { background-color: var(--secondary-color); font-size: 0.8em; padding: 6px 12px; white-space: nowrap; }
        #skip-to-real-game-btn:hover, #back-to-learning-btn:hover { background-color: var(--secondary-hover); }
        button:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0px); }
        button:disabled { background-color: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; transform: none; opacity: 0.7; }
        #feedback-area { margin-top: 10px; padding: 10px 12px; border-radius: 5px; font-weight: 500; text-align: center; border: 1px solid transparent; transition: all var(--animation-speed) ease; opacity: 0; transform: translateY(5px); min-height: 42px; font-size: 0.85em; flex-shrink: 0; line-height: 1.4; }
        #feedback-area.visible { opacity: 1; transform: translateY(0); }
        .feedback-correct { background-color: var(--feedback-correct-bg); color: var(--feedback-correct-text); border-color: var(--feedback-correct-border); }
        .feedback-incorrect { background-color: var(--feedback-incorrect-bg); color: var(--feedback-incorrect-text); border-color: var(--feedback-incorrect-border); }
        .hidden { display: none !important; }
        .feedback-icon { font-weight: bold; margin: 0 3px; font-size: 1.1em; line-height: 1; vertical-align: middle;}
        .feedback-icon.ok { color: var(--feedback-correct-text); }
        .feedback-icon.err { color: var(--feedback-incorrect-text); }

        /* Fullscreen */
        #simulator-container:fullscreen { background-color: var(--bg-color); padding: 10px; width: 100vw; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        #simulator-container:fullscreen #simulator-section { height: 100%; }
        #simulator-container:-webkit-full-screen { background-color: var(--bg-color); width: 100vw; height: 100vh; padding: 10px; }
        #simulator-container:-moz-full-screen { background-color: var(--bg-color); width: 100vw; height: 100vh; padding: 10px; }
        body:has(#simulator-container:fullscreen) > .header, body:has(#simulator-container:fullscreen) > .game-container > #level-info, body:has(#simulator-container:fullscreen) > .game-container > .main-content > #learning-section, body:has(#simulator-container:fullscreen) > .game-container > .main-content > .resizer, body:has(#simulator-container:fullscreen) > .game-container > #level-complete, body:has(#simulator-container:fullscreen) > .game-container > #game-complete { display: none; }
        body:has(#simulator-container:fullscreen) > .game-container { padding: 0; border: none; box-shadow: none; border-radius: 0; }
        body:has(#simulator-container:fullscreen) > .game-container > .main-content { padding: 0; margin: 0; gap: 0; }

        /* Level/Game Complete */
        #level-complete, #game-complete { text-align: center; padding: 20px; }
        #level-complete h2, #game-complete h2 { color: var(--bullish-color); }
        body.dark-theme #level-complete h2, body.dark-theme #game-complete h2 { color: var(--bullish-color); }
        #level-complete p, #game-complete p { font-size: 1.0em; margin-bottom: 10px; }
        #game-complete .bankrupt-message { color: var(--bearish-color); font-weight: bold; }

    </style>
</head>
<body>
    <!-- Audio Elements -->
    <audio id="sound-correct" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAIAAD/ACAAAQ==" preload="auto"></audio>
    <audio id="sound-incorrect" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAIAAD/AAD/AAAAAA==" preload="auto"></audio>
    <audio id="sound-click" src="data:audio/wav;base64,UklGRkoAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YXQAAAAA//8=" preload="auto"></audio>

    <div class="game-container" id="game-container">
        <div class="header">
             <div class="header-left">
                 <h1>Survesh Bajpai's Candlestick Master Pro</h1>
                 <div class="game-stats">
                    <span id="level-stat">Level: <span id="current-level">1</span></span>
                    <span>Score: <span id="current-score">0</span></span>
                    <!-- Capital and Streak hidden/shown by JS -->
                    <span class="capital hidden" id="capital-stat">Capital: $<span id="trading-capital">10000</span></span>
                    <span class="streak hidden" id="streak-stat">Streak: <span id="current-streak">0</span> &#x1F525;</span>
                </div>
            </div>
             <div class="header-right">
                 <button id="back-to-learning-btn" class="hidden">Back to Learning</button>
                 <!-- Renamed button -->
                 <button id="skip-to-trading-sim-btn">Trading Simulator</button>
                 <div class="theme-switch-wrapper">
                     <label for="theme-toggle">Dark</label>
                     <label class="theme-switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label>
                 </div>
             </div>
        </div>

         <div id="level-info" class="section">
             <div class="level-nav-buttons">
                 <button id="prev-level-btn" class="hidden">Prev Level</button>
                 <button id="skip-level-btn" class="hidden">Next Level</button> <!-- Renamed from Skip -->
             </div>
             <h2 id="level-info-title">Level <span id="learning-level">1</span> Focus</h2>
             <!-- Updated instructions for score percentage -->
             <p id="level-instructions">Study patterns, identify & predict. Reach <strong>75% score</strong> for this level to advance.</p>
             <div class="progress-bar-container hidden">
                 <div id="level-progress-bar" class="progress-bar-fill"></div>
             </div>
             <p id="level-progress-info" class="hidden">Level Score: <span id="level-score-percent">0</span>% (Need 75%)</p>
             <!-- Updated real game message -->
             <p id="real-game-message" class="hidden">Trading Simulator: Identify patterns & predict trend/term for 50 candles! Manage capital.</p>
         </div>

        <div class="main-content">
            <div id="learning-section" class="section">
                <h2>Pattern Library (Level <span id="learning-level-title">1</span>)</h2>
                <div id="learning-content"><ul></ul></div>
            </div>
            <div class="resizer" id="resizer"></div>
            <div id="simulator-container">
                <button id="toggle-fullscreen-btn" title="Toggle Fullscreen Simulator">Fullscreen</button>
                <div id="simulator-section" class="section">
                    <h2 id="simulator-title">Simulator Challenge</h2>
                    <div id="chart-container"></div>
                    <div class="simulator-controls">
                        <div class="input-area">
                            <div id="pattern-selection"><label for="pattern-select">1. Identify Pattern:</label><select id="pattern-select"><option value="">-- Select --</option></select></div>
                            <div id="prediction-input"><label for="prediction-select">2. Predict Trend:</label><select id="prediction-select"><option value="">-- Select --</option><option value="up">Up Trend</option><option value="down">Down Trend</option><option value="sideways">Sideways / Choppy</option></select></div>
                            <div id="term-prediction"><label for="term-select">3. Predict Term:</label><select id="term-select"><option value="">-- Select --</option><option value="short">Short (Peak 1-15)</option><option value="mid">Mid (Peak 16-34)</option><option value="long">Long (Peak 35-50)</option></select></div>
                        </div>
                        <div class="action-area"><button id="submit-reveal-button">Submit & Reveal</button><button id="next-challenge-button" class="hidden">Next Challenge</button></div>
                        <div id="feedback-area"></div>
                    </div>
                </div>
            </div>
        </div>

         <div id="level-complete" class="section hidden">
             <h2>Level <span id="completed-level-num">1</span> Mastered!</h2>
             <!-- Removed capital change display for learning -->
             <p>Cumulative Score: <span id="level-final-score">0</span> | Level Accuracy: <span id="level-accuracy-percent">0</span>%</p>
             <button id="next-level-button">Proceed</button>
         </div>
         <div id="game-complete" class="section hidden">
              <h2 id="game-complete-title">Congratulations! Grand Master!</h2>
              <p id="game-complete-message">Final Score: <span id="final-score">0</span> | Final Capital: $<span id="final-capital">10000</span></p>
              <button onclick="location.reload()">Play Again?</button>
          </div>
    </div>

    <script>
        // --- Constants & Data (Needs significant expansion) ---
        const PATTERN_PROBABILITY = 0.75;
        const VOLATILITY_FACTOR = 0.018;
        const PATTERNS = [ /* --- ADD ~35 MORE PATTERNS --- */ /* L1 */ { name: "Hammer", type: "bullish reversal", candles: 1, level: 1, term: 'short', desc: "Downtrend. Small body, long lower wick.", example: [{o:105,h:106,l:104,c:104.5}, {o:104.5,h:105,l:102,c:103}, {o:103,h:103.5,l:100,c:101}, {o:101, h:102, l:95, c:101.5}] }, { name: "Inverted Hammer", type: "bullish reversal", candles: 1, level: 1, term: 'short', strength: 'low', desc: "Downtrend. Small body, long upper wick.", example: [{o:110,h:111,l:108,c:109}, {o:109,h:109.5,l:106,c:107}, {o:107,h:107.5,l:104,c:105}, {o:105, h:111, l:104.5, c:105.5}] }, { name: "Bullish Marubozu", type: "bullish cont./rev.", candles: 1, level: 1, term: 'short-mid', strength: 'high', desc: "Long green body, no wicks.", example: [{o:100,h:101,l:99,c:100.5}, {o:100.5,h:102,l:100,c:101}, {o:101, h:106, l:101, c:106}] }, { name: "Hanging Man", type: "bearish reversal", candles: 1, level: 1, term: 'short', strength: 'medium', desc: "Uptrend. Looks like Hammer. Potential top.", example: [{o:95,h:97,l:94,c:96}, {o:96,h:99,l:95.5,c:98}, {o:98,h:101,l:97,c:100}, {o:100, h:101, l:94, c:100.5}] }, { name: "Shooting Star", type: "bearish reversal", candles: 1, level: 1, term: 'short', strength: 'medium', desc: "Uptrend. Small body, long upper wick.", example: [{o:102,h:104,l:101,c:103}, {o:103,h:106,l:102.5,c:105}, {o:105,h:108,l:104,c:107}, {o:107, h:113, l:106.5, c:107.5}] }, { name: "Bearish Marubozu", type: "bearish cont./rev.", candles: 1, level: 1, term: 'short-mid', strength: 'high', desc: "Long red body, no wicks.", example: [{o:110,h:111,l:109,c:110.5}, {o:110.5,h:111.5,l:110,c:111}, {o:111, h:111, l:106, c:106}] }, /* L2 */ { name: "Doji", type: "neutral/reversal", candles: 1, level: 2, term: 'short', strength: 'low', desc: "Open â‰ˆ Close. Indecision.", example: [{o:100,h:101,l:99,c:100.5}, {o:100.5, h:103, l:98, c:100.6}] }, { name: "Dragonfly Doji", type: "bullish reversal", candles: 1, level: 2, term: 'short', strength: 'high', desc: "Downtrend. Open=High=Close, long lower wick.", example: [{o:105,h:106,l:103,c:104}, {o:104,h:104.5,l:101,c:102}, {o:102, h:102.5, l:95, c:102.1}] }, { name: "Gravestone Doji", type: "bearish reversal", candles: 1, level: 2, term: 'short', strength: 'high', desc: "Uptrend. Open=Low=Close, long upper wick.", example: [{o:95,h:97,l:94,c:96}, {o:96,h:99,l:95.5,c:98}, {o:98, h:105, l:98, c:98.1}] }, { name: "Bullish Engulfing", type: "bullish reversal", candles: 2, level: 2, term: 'mid', strength: 'high', desc: "Downtrend. Bull engulfs prior Bear.", example: [{o:105,h:105.5,l:102,c:103}, {o:103,h:103.5,l:100,c:101}, {o:101,h:102,l:100.5,c:101.5}, {o:100, h:104, l:99.5, c:103.5}] }, { name: "Bearish Engulfing", type: "bearish reversal", candles: 2, level: 2, term: 'mid', strength: 'high', desc: "Uptrend. Bear engulfs prior Bull.", example: [{o:90,h:92,l:89,c:91}, {o:91,h:94,l:90.5,c:93}, {o:93,h:96,l:92.5,c:95}, {o:96, h:96.5, l:92, c:92.5}] }, /* L3 */ { name: "Piercing Line", type: "bullish reversal", candles: 2, level: 3, term: 'mid', strength: 'medium', desc: "Downtrend. Bear -> Bull closes >50% into Bear.", example: [{o:105,h:105.5,l:102,c:103}, {o:103,h:103.5,l:99,c:100}, {o:98, h:102, l:97.5, c:101.8}] }, { name: "Dark Cloud Cover", type: "bearish reversal", candles: 2, level: 3, term: 'mid', strength: 'medium', desc: "Uptrend. Bull -> Bear closes >50% into Bull.", example: [{o:95,h:97,l:94,c:96}, {o:96,h:100,l:95.5,c:99}, {o:101, h:101.5, l:97, c:97.5}] }, { name: "Tweezer Bottoms", type: "bullish reversal", candles: 2, level: 3, term: 'short-mid', strength: 'medium', desc: "Downtrend. Matching lows.", example: [{o:103,h:104,l:100,c:101}, {o:101.5, h:102.5, l:98, c:100.5}, {o:100.8, h:102, l:98, c:101.5}] }, { name: "Tweezer Tops", type: "bearish reversal", candles: 2, level: 3, term: 'short-mid', strength: 'medium', desc: "Uptrend. Matching highs.", example: [{o:97,h:100,l:96,c:99}, {o:99.5, h:103, l:98, c:101}, {o:102, h:103, l:100, c:100.5}] }, { name: "Morning Star", type: "bullish reversal", candles: 3, level: 3, term: 'mid-long', strength: 'high', desc: "Downtrend. Bear -> Gap down small -> Bull.", example: [{o:110,h:110.5,l:105,c:106}, {o:103, h:104, l:102, c:103.5}, {o:105, h:111, l:104.5, c:110}] }, { name: "Evening Star", type: "bearish reversal", candles: 3, level: 3, term: 'mid-long', strength: 'high', desc: "Uptrend. Bull -> Gap up small -> Bear.", example: [{o:90,h:95,l:89,c:94}, {o:97, h:98, l:96, c:97.5}, {o:96, h:96.5, l:90, c:91}] }, /* L4 */ { name: "Rising Three Methods", type: "bullish cont.", candles: 5, level: 4, term: 'mid-long', strength: 'medium', desc: "Uptrend. Bull -> 3 Bear pullback -> Bull breaks high.", example: [{o:100,h:105,l:99,c:104}, {o:103.5,h:104,l:102,c:102.5}, {o:102,h:103,l:101,c:101.5}, {o:101,h:102,l:100,c:100.5}, {o:101,h:107,l:100.5,c:106}] }, { name: "Falling Three Methods", type: "bearish cont.", candles: 5, level: 4, term: 'mid-long', strength: 'medium', desc: "Downtrend. Bear -> 3 Bull rally -> Bear breaks low.", example: [{o:110,h:111,l:105,c:106}, {o:106.5,h:108,l:106,c:107.5}, {o:108,h:109,l:107,c:108.5}, {o:109,h:110,l:108,c:109.5}, {o:108.5,h:109,l:103,c:104}] }, { name: "Three White Soldiers", type: "bullish reversal", candles: 3, level: 4, term: 'mid', strength: 'high', desc: "Downtrend. Three strong Bulls.", example: [{o:100,h:101,l:98,c:99}, {o:100,h:104,l:99.5,c:103.5}, {o:104,h:108,l:103.5,c:107.5}, {o:108,h:112,l:107.5,c:111.5}] }, { name: "Three Black Crows", type: "bearish reversal", candles: 3, level: 4, term: 'mid', strength: 'high', desc: "Uptrend. Three strong Bears.", example: [{o:110,h:112,l:109,c:111}, {o:110,h:110.5,l:106,c:106.5}, {o:106,h:106.5,l:102,c:102.5}, {o:102,h:102.5,l:98,c:98.5}] }, { name: "Bullish Separating Lines", type: "bullish cont.", candles: 2, level: 4, term: 'mid', strength: 'medium', desc: "Uptrend. Bear -> Bull Marubozu opens at same level.", example: [{o:110,h:115,l:109,c:114}, {o:111,h:112,l:108,c:109}, {o:109, h:116, l:109, c:116}] }, /* L5 */ { name: "Bullish Harami", type: "bullish reversal", candles: 2, level: 5, term: 'short-mid', strength: 'medium', desc: "Downtrend. Large Bear -> small Bull inside.", example: [{o:110,h:111,l:104,c:105}, {o:106,h:108,l:105.5,c:107.5}] }, { name: "Bearish Harami", type: "bearish reversal", candles: 2, level: 5, term: 'short-mid', strength: 'medium', desc: "Uptrend. Large Bull -> small Bear inside.", example: [{o:90,h:97,l:89.5,c:96}, {o:95,h:95.5,l:93,c:93.5}] }, { name: "Bullish Harami Cross", type: "bullish reversal", candles: 2, level: 5, term: 'short-mid', strength: 'high', desc: "Downtrend. Large Bear -> Doji inside.", example: [{o:112,h:113,l:105,c:106}, {o:107,h:109,l:106.5,c:107.1}] }, { name: "Bearish Harami Cross", type: "bearish reversal", candles: 2, level: 5, term: 'short-mid', strength: 'high', desc: "Uptrend. Large Bull -> Doji inside.", example: [{o:92,h:100,l:91.5,c:99}, {o:98,h:98.5,l:97,c:97.9}] }, { name: "Upside Tasuki Gap", type: "bullish cont.", candles: 3, level: 5, term: 'mid', strength: 'medium', desc: "Uptrend. Bull -> Gapped Bull -> Bear closes in gap.", example: [{o:100,h:104,l:99.5,c:103.5},{o:105,h:109,l:104.5,c:108},{o:107,h:107.5,l:104,c:105}] }, { name: "Downside Tasuki Gap", type: "bearish cont.", candles: 3, level: 5, term: 'mid', strength: 'medium', desc: "Downtrend. Bear -> Gapped Bear -> Bull closes in gap.", example: [{o:110,h:110.5,l:106,c:106.5},{o:105,h:105.5,l:101,c:102},{o:103,h:106,l:102.5,c:105.5}] }, /* L6 */ { name: "Three Inside Up", type: "bullish reversal", candles: 3, level: 6, term: 'mid', strength: 'high', desc: "Downtrend. Bullish Harami confirmed.", example: [{o:110,h:111,l:104,c:105}, {o:106,h:108,l:105.5,c:107.5}, {o:108,h:112,l:107.5,c:111}] }, { name: "Three Inside Down", type: "bearish reversal", candles: 3, level: 6, term: 'mid', strength: 'high', desc: "Uptrend. Bearish Harami confirmed.", example: [{o:90,h:97,l:89.5,c:96}, {o:95,h:95.5,l:93,c:93.5}, {o:93,h:93.5,l:89,c:90}] }, { name: "Three Outside Up", type: "bullish reversal", candles: 3, level: 6, term: 'mid', strength: 'high', desc: "Downtrend. Bullish Engulfing confirmed.", example: [{o:105,h:105.5,l:102,c:103}, {o:101, h:106, l:100.5, c:105.5}, {o:106,h:110,l:105.5,c:109}] }, { name: "Three Outside Down", type: "bearish reversal", candles: 3, level: 6, term: 'mid', strength: 'high', desc: "Uptrend. Bearish Engulfing confirmed.", example: [{o:90,h:92,l:89,c:91},{o:92, h:92.5, l:88, c:89}, {o:88.5,h:89,l:85,c:86}] }, { name: "Bullish Stick Sandwich", type: "bullish reversal", candles: 3, level: 6, term: 'mid', strength: 'medium', desc: "Downtrend. Bear -> Bull -> Bear closes at same level.", example: [{o:105,h:105.5,l:100,c:100.5},{o:101,h:104,l:100.5,c:103},{o:103.5,h:104,l:100,c:100.5}] }, /* L7 */ { name: "Bullish Kicking", type: "bullish reversal", candles: 2, level: 7, term: 'short-mid', strength: 'high', desc: "Bear Marubozu -> Gapped up Bull Marubozu.", example: [{o:110,h:110,l:105,c:105},{o:107,h:112,l:107,c:112}] }, { name: "Bearish Kicking", type: "bearish reversal", candles: 2, level: 7, term: 'short-mid', strength: 'high', desc: "Bull Marubozu -> Gapped down Bear Marubozu.", example: [{o:90,h:95,l:90,c:95},{o:88,h:88,l:83,c:83}] }, { name: "On Neck Line", type: "bearish cont.", candles: 2, level: 7, term: 'mid', strength: 'medium', desc: "Downtrend. Bear -> Small Bull closes near prior close.", example: [{o:120,h:121,l:112,c:113}, {o:112,h:115,l:111,c:113.2}] }, { name: "Bullish Thrusting Line", type: "bullish cont.", candles: 2, level: 7, term: 'mid', strength: 'medium', desc: "Uptrend. Bull -> Bear closes > midpoint in prior body.", example: [{o:130,h:138,l:129.5,c:137}, {o:139,h:140,l:134,c:135}] }, { name: "Homing Pigeon", type: "bullish reversal", candles: 2, level: 7, term: 'short-mid', strength: 'medium', desc: "Downtrend. Large Bear -> smaller Bear inside.", example: [{o:108,h:109,l:100,c:101}, {o:103,h:104,l:101.5,c:102}] }, /* L8 */ { name: "Mat Hold", type: "bullish cont.", candles: 5, level: 8, term: 'mid-long', strength: 'high', desc: "Uptrend. Bull -> Gap -> 3 Bear pullback -> Bull breaks high.", example: [{o:120,h:128,l:119,c:127},{o:128,h:129,l:126,c:127},{o:126.5,h:127.5,l:125,c:125.5},{o:125,h:126,l:124,c:124.5},{o:125,h:132,l:124.5,c:131}] }, { name: "Bullish Side-by-Side White Lines", type: "bullish cont.", candles: 3, level: 8, term: 'mid', strength: 'high', desc: "Uptrend. Bull -> Gap up -> Two similar Bulls.", example: [{o:110,h:115,l:109.5,c:114},{o:116,h:120,l:115.5,c:119},{o:119.5,h:123,l:119,c:122}] }, { name: "Bearish Side-by-Side White Lines", type: "bearish cont.", candles: 3, level: 8, term: 'mid', strength: 'high', desc: "Downtrend. Bear -> Gap down -> Two similar Bulls.", example: [{o:100,h:101,l:95,c:96},{o:93,h:95,l:92.5,c:94.5},{o:94,h:96,l:93.5,c:95.5}] }, { name: "Matching Low", type: "bullish support/rev", candles: 2, level: 8, term: 'mid', strength: 'medium', desc: "Downtrend. Two Bears close at same low.", example: [{o:105,h:106,l:100,c:101}, {o:102,h:102.5,l:100,c:100.2}] }, { name: "Matching High", type: "bearish resist/rev", candles: 2, level: 8, term: 'mid', strength: 'medium', desc: "Uptrend. Two Bulls close at same high.", example: [{o:120,h:125,l:119.5,c:124},{o:124.5,h:125,l:123,c:124.8}] }, /* L9 */ { name: "Concealing Baby Swallow", type: "bullish reversal", candles: 4, level: 9, term: 'long', strength: 'high', desc: "Downtrend. Rare 4-candle reversal.", example: [{o:150,h:150,l:140,c:140},{o:140,h:140,l:130,c:130},{o:128,h:132,l:127,c:131},{o:129,h:130,l:125,c:126}] }, { name: "Ladder Bottom", type: "bullish reversal", candles: 5, level: 9, term: 'mid-long', strength: 'medium', desc: "Downtrend. 3 Bears -> Wick -> Bull gaps up.", example: [{o:110,h:111,l:105,c:106},{o:106,h:107,l:101,c:102},{o:102,h:103,l:97,c:98},{o:98,h:102,l:96,c:97},{o:99,h:104,l:98.5,c:103.5}] }, { name: "Bullish Tri-Star", type: "bullish reversal", candles: 3, level: 9, term: 'mid', strength: 'high', desc: "Downtrend. Doji -> Gap down Doji -> Gap up Doji.", example: [{o:105,h:106,l:102,c:103},{o:100,h:101.5,l:99.5,c:100.1},{o:102,h:103,l:101.5,c:102.2}] }, { name: "Bearish Tri-Star", type: "bearish reversal", candles: 3, level: 9, term: 'mid', strength: 'high', desc: "Uptrend. Doji -> Gap up Doji -> Gap down Doji.", example: [{o:120,h:124,l:119.5,c:123},{o:125,h:126,l:124.5,c:125.1},{o:123,h:124,l:122.5,c:123.2}] }, { name: "Unique 3 River Bottom", type: "bullish reversal", candles: 3, level: 9, term: 'mid-long', strength: 'high', desc: "Downtrend. Bear -> Harami Cross -> Bull below Doji.", example: [{o:115,h:116,l:108,c:109},{o:110,h:111,l:106,c:107},{o:105,h:107.5,l:104.5,c:106.5}] }, /* L10 */ { name: "Advance Block", type: "bearish reversal", candles: 3, level: 10, term: 'mid', strength: 'medium', desc: "Uptrend. Weakening white soldiers.", example: [{o:130,h:138,l:129,c:137},{o:137.5,h:142,l:137,c:141},{o:141.2,h:145,l:140.8,c:143}] }, { name: "Deliberation (Stalled)", type: "bearish reversal", candles: 3, level: 10, term: 'mid', strength: 'medium', desc: "Uptrend. Advance Block with small gapped 3rd.", example: [{o:140,h:146,l:139,c:145},{o:145.5,h:150,l:145,c:149},{o:150,h:151.5,l:149.5,c:150.2}] }, { name: "Bearish Stick Sandwich", type: "bearish reversal", candles: 3, level: 10, term: 'mid', strength: 'medium', desc: "Uptrend. Bull -> Bear -> Bull closes at same level.", example: [{o:115,h:120,l:114.5,c:119.5},{o:119,h:119.5,l:115,c:116},{o:115.5,h:120,l:115,c:119.5}]}, { name: "Bearish Breakaway", type: "bearish reversal", candles: 5, level: 10, term: 'mid-long', strength: 'high', desc: "Uptrend. Bull -> Gap Bull -> Pullback -> Bear gaps down.", example: [{o:100,h:105,l:99.5,c:104},{o:106,h:110,l:105.5,c:109},{o:108,h:109,l:107,c:107.5},{o:107,h:108,l:106,c:106.5},{o:105,h:106,l:100,c:101}] }, { name: "Bullish Breakaway", type: "bullish reversal", candles: 5, level: 10, term: 'mid-long', strength: 'high', desc: "Downtrend. Bear -> Gap Bear -> Rally -> Bull gaps up.", example: [{o:100,h:100.5,l:95,c:96},{o:94,h:94.5,l:90,c:91},{o:92,h:94,l:91.5,c:93.5},{o:94,h:96,l:93.5,c:95.5},{o:97,h:102,l:96.5,c:101}] }
            // --- ADD ~30 MORE PATTERNS ---
        ];
        const CHALLENGES = [ // ADD ~70+ Learning & ~185+ Real challenges
            // ... (Keep existing L1-L10 + Real examples, add many more)
            // --- L1-L10 examples from previous response ---
             // --- L1 --- (Needs ~0 more for 10 total)
             { level: 1, data: [{o:102,h:103,l:101,c:102},{o:103,h:104,l:100,c:101},{o:101,h:102,l:99,c:100},{o:100,h:101,l:97,c:98},{o:98,h:99,l:95,c:96}, {o:96, h:98, l:90, c:97}], pattern: "Hammer", expectedOutcome: "up" },
             { level: 1, data: [{o:95,h:96,l:94,c:95},{o:95,h:98,l:94,c:97},{o:97,h:100,l:96,c:99},{o:99,h:103,l:97,c:102}, {o:102,h:108,l:101,c:102.5}], pattern: "Shooting Star", expectedOutcome: "down" },
             { level: 1, data: [{o:105,h:105.5,l:104,c:104.2}, {o:104.2, h:108, l:104.2, c:108}], pattern: "Bullish Marubozu", expectedOutcome: "up" },
             { level: 1, data: [{o:90,h:91,l:89,c:90.5},{o:90.5,h:90.5,l:86,c:86}], pattern: "Bearish Marubozu", expectedOutcome: "down" },
             { level: 1, data: [{o:110,h:111,l:108,c:109}, {o:109,h:109.5,l:106,c:107}, {o:107,h:107.5,l:104,c:105}, {o:105, h:111, l:104.5, c:105.5}], pattern: "Inverted Hammer", expectedOutcome: "up" },
             { level: 1, data: [{o:95,h:97,l:94,c:96}, {o:96,h:99,l:95.5,c:98}, {o:98,h:101,l:97,c:100}, {o:100, h:101, l:94, c:100.5}], pattern: "Hanging Man", expectedOutcome: "down" },
             { level: 1, data: [{o:100,h:101,l:99,c:100}, {o:100,h:102,l:98,c:99}, {o:99,h:100,l:96,c:97}], pattern: "None", expectedOutcome: "down"},
             { level: 1, data: [{o:110,h:110.5,l:108,c:109},{o:109,h:109.5,l:107,c:108},{o:108,h:108.5,l:104,c:105}], pattern: "None", expectedOutcome: "down"},
             { level: 1, data: [{o:101,h:102,l:95,c:101.5},{o:102,h:104,l:101,c:103}], pattern: "Hammer", expectedOutcome: "up" },
             { level: 1, data: [{o:107,h:113,l:106.5,c:107.5},{o:108,h:110,l:107,c:109}], pattern: "Shooting Star", expectedOutcome: "down" },
            // --- L2 --- (Needs ~0 more for 10 total)
             { level: 2, data: [{o:105,h:106,l:100,c:101},{o:101,h:103,l:99,c:102},{o:102,h:102.5,l:98,c:99},{o:99,h:100,l:97,c:98}, {o:98,h:100,l:94, c:98.5}], pattern: "Doji", expectedOutcome: "sideways" },
             { level: 2, data: [{o:110,h:111,l:107,c:108},{o:108,h:109,l:105,c:106}, {o:106,h:107,l:103,c:104}, {o:104,h:105,l:101,c:102},{o:102,h:103,l:99,c:100}, {o:99,h:106,l:98,c:105}], pattern: "Bullish Engulfing", expectedOutcome: "up" },
             { level: 2, data: [{o:95,h:97,l:94,c:96}, {o:96,h:99,l:95.5,c:98}, {o:98, h:105, l:98, c:98.1}], pattern: "Gravestone Doji", expectedOutcome: "down" },
             { level: 2, data: [{o:90,h:92,l:89,c:91}, {o:91,h:94,l:90.5,c:93}, {o:93,h:96,l:92.5,c:95}, {o:96, h:96.5, l:92, c:92.5}], pattern: "Bearish Engulfing", expectedOutcome: "down" },
             { level: 2, data: [{o:105,h:106,l:103,c:104}, {o:104,h:104.5,l:101,c:102}, {o:102, h:102.5, l:95, c:102.1}], pattern: "Dragonfly Doji", expectedOutcome: "up" },
             { level: 2, data: [{o:100,h:101,l:99,c:100}, {o:100,h:103,l:98,c:99}], pattern: "None", expectedOutcome: "sideways"},
             { level: 2, data: [{o:115,h:116,l:112,c:113},{o:113,h:115,l:112.5,c:114.5}], pattern: "None", expectedOutcome: "up"},
             { level: 2, data: [{o:108,h:109,l:105,c:106}, {o:106,h:107,l:103,c:104},{o:102, h:104.5, l:98, c:104}], pattern: "Bullish Engulfing", expectedOutcome: "up" },
             { level: 2, data: [{o:93,h:96,l:92.5,c:95}, {o:96, h:96.5, l:92, c:92.5},{o:91,h:92,l:88,c:89}], pattern: "Bearish Engulfing", expectedOutcome: "down" },
             { level: 2, data: [{o:102, h:102.5, l:95, c:102.1}, {o:102.2, h:105, l:101.8, c:104.5}], pattern: "Dragonfly Doji", expectedOutcome: "up" },
            // --- L3 --- (Needs ~0 more)
             { level: 3, data: [{o:115,h:116,l:110,c:111}, {o:111,h:112,l:105,c:106}, {o:105,h:110,l:104,c:109}], pattern: "Piercing Line", expectedOutcome: "up" },
             { level: 3, data: [{o:90,h:95,l:89,c:94}, {o:98,h:99,l:97,c:98.5}, {o:97,h:97.5,l:91,c:92}], pattern: "Evening Star", expectedOutcome: "down"},
             { level: 3, data: [{o:103,h:104,l:100,c:101}, {o:101.5, h:102.5, l:98, c:100.5}, {o:100.8, h:102, l:98, c:101.5}], pattern: "Tweezer Bottoms", expectedOutcome: "up" },
             { level: 3, data: [{o:95,h:97,l:94,c:96}, {o:96,h:100,l:95.5,c:99}, {o:101, h:101.5, l:97, c:97.5}], pattern: "Dark Cloud Cover", expectedOutcome: "down"},
             { level: 3, data: [{o:97,h:100,l:96,c:99}, {o:99.5, h:103, l:98, c:101}, {o:102, h:103, l:100, c:100.5}], pattern: "Tweezer Tops", expectedOutcome: "down" },
             { level: 3, data: [{o:110,h:110.5,l:105,c:106}, {o:103, h:104, l:102, c:103.5}, {o:105, h:111, l:104.5, c:110}], pattern: "Morning Star", expectedOutcome: "up" },
             { level: 3, data: [{o:105,h:106,l:103,c:104},{o:104,h:105,l:102,c:103},{o:103,h:104,l:101,c:102}], pattern: "None", expectedOutcome: "down"},
             { level: 3, data: [{o:105,h:110,l:104,c:109},{o:109.5,h:112,l:108,c:111}], pattern: "Piercing Line", expectedOutcome: "up" },
             { level: 3, data: [{o:97,h:97.5,l:91,c:92},{o:91.5,h:92.5,l:88,c:89}], pattern: "Evening Star", expectedOutcome: "down"},
             { level: 3, data: [{o:100.8, h:102, l:98, c:101.5},{o:101.8,h:104,l:101,c:103.5}], pattern: "Tweezer Bottoms", expectedOutcome: "up" },
            // --- L4 --- (Needs ~0 more)
             { level: 4, data: [{o:95,h:98,l:90,c:91},{o:92,h:99,l:91.5,c:98},{o:98.5,h:105,l:98,c:104},{o:104.5,h:110,l:104,c:109}], pattern: "Three White Soldiers", expectedOutcome: "up"},
             { level: 4, data: [{o:115,h:120,l:114,c:119},{o:118,h:119,l:112,c:113},{o:112.5,h:113,l:107,c:108},{o:107.5,h:108,l:102,c:103}], pattern: "Three Black Crows", expectedOutcome: "down"},
             { level: 4, data: [{o:100,h:105,l:99,c:104}, {o:103.5,h:104,l:102,c:102.5}, {o:102,h:103,l:101,c:101.5}, {o:101,h:102,l:100,c:100.5}, {o:101,h:107,l:100.5,c:106}], pattern: "Rising Three Methods", expectedOutcome: "up" },
             { level: 4, data: [{o:110,h:111,l:105,c:106}, {o:106.5,h:108,l:106,c:107.5}, {o:108,h:109,l:107,c:108.5}, {o:109,h:110,l:108,c:109.5}, {o:108.5,h:109,l:103,c:104}], pattern: "Falling Three Methods", expectedOutcome: "down" },
             { level: 4, data: [{o:120,h:122,l:118,c:121},{o:121,h:123,l:119,c:122},{o:122,h:124,l:120,c:123}], pattern: "None", expectedOutcome: "up"},
             { level: 4, data: [{o:110,h:115,l:109,c:114}, {o:111,h:112,l:108,c:109}, {o:109, h:116, l:109, c:116}], pattern: "Bullish Separating Lines", expectedOutcome: "up" },
             { level: 4, data: [{o:104.5,h:110,l:104,c:109},{o:109.5,h:112,l:108,c:111}], pattern: "Three White Soldiers", expectedOutcome: "up"},
             { level: 4, data: [{o:107.5,h:108,l:102,c:103},{o:102.5,h:103,l:98,c:99}], pattern: "Three Black Crows", expectedOutcome: "down"},
             { level: 4, data: [{o:101,h:107,l:100.5,c:106},{o:106.5,h:108,l:105,c:107}], pattern: "Rising Three Methods", expectedOutcome: "up" },
             { level: 4, data: [{o:108.5,h:109,l:103,c:104},{o:103.5,h:104,l:100,c:101}], pattern: "Falling Three Methods", expectedOutcome: "down" },
            // --- L5 --- (Needs ~0 more for 10 total)
             { level: 5, data: [{o:115,h:116,l:110,c:111},{o:111,h:111.5,l:105,c:106},{o:107,h:109,l:106.5,c:108}], pattern: "Bullish Harami", expectedOutcome: "up" },
             { level: 5, data: [{o:95,h:100,l:94.5,c:99},{o:98,h:98.5,l:96,c:96.5}], pattern: "Bearish Harami", expectedOutcome: "down" },
             { level: 5, data: [{o:100,h:104,l:99.5,c:103.5},{o:105,h:109,l:104.5,c:108},{o:107,h:107.5,l:104,c:105}], pattern: "Upside Tasuki Gap", expectedOutcome: "up" },
             { level: 5, data: [{o:110,h:110.5,l:106,c:106.5},{o:105,h:105.5,l:101,c:102},{o:103,h:106,l:102.5,c:105.5}], pattern: "Downside Tasuki Gap", expectedOutcome: "down" },
             { level: 5, data: [{o:112,h:113,l:105,c:106}, {o:107,h:109,l:106.5,c:107.1}], pattern: "Bullish Harami Cross", expectedOutcome: "up" },
             { level: 5, data: [{o:92,h:100,l:91.5,c:99}, {o:98,h:98.5,l:97,c:97.9}], pattern: "Bearish Harami Cross", expectedOutcome: "down" },
             { level: 5, data: [{o:106,h:108,l:105.5,c:107.5},{o:107,h:109,l:106,c:108.5}], pattern: "Bullish Harami", expectedOutcome: "up" },
             { level: 5, data: [{o:98,h:98.5,l:96,c:96.5},{o:96,h:97,l:94,c:95}], pattern: "Bearish Harami", expectedOutcome: "down" },
             { level: 5, data: [{o:107,h:107.5,l:104,c:105},{o:106,h:108,l:105,c:107}], pattern: "Upside Tasuki Gap", expectedOutcome: "up" },
             { level: 5, data: [{o:103,h:106,l:102.5,c:105.5},{o:104,h:106.5,l:103,c:106}], pattern: "Downside Tasuki Gap", expectedOutcome: "down" },
            // --- L6 --- (Needs ~0 more for 10 total)
             { level: 6, data: [{o:110,h:111,l:104,c:105}, {o:106,h:108,l:105.5,c:107.5}, {o:108,h:112,l:107.5,c:111}], pattern: "Three Inside Up", expectedOutcome: "up" },
             { level: 6, data: [{o:90,h:97,l:89.5,c:96}, {o:95,h:95.5,l:93,c:93.5}, {o:93,h:93.5,l:89,c:90}], pattern: "Three Inside Down", expectedOutcome: "down" },
             { level: 6, data: [{o:105,h:105.5,l:102,c:103}, {o:101, h:106, l:100.5, c:105.5}, {o:106,h:110,l:105.5,c:109}], pattern: "Three Outside Up", expectedOutcome: "up" },
             { level: 6, data: [{o:90,h:92,l:89,c:91},{o:92, h:92.5, l:88, c:89}, {o:88.5,h:89,l:85,c:86}], pattern: "Three Outside Down", expectedOutcome: "down" },
             { level: 6, data: [{o:105,h:105.5,l:100,c:100.5},{o:101,h:104,l:100.5,c:103},{o:103.5,h:104,l:100,c:100.5}], pattern: "Bullish Stick Sandwich", expectedOutcome: "up" },
             { level: 6, data: [{o:106,h:108,l:105.5,c:107.5}, {o:108,h:112,l:107.5,c:111},{o:111.5,h:114,l:110,c:113}], pattern: "Three Inside Up", expectedOutcome: "up" },
             { level: 6, data: [{o:95,h:95.5,l:93,c:93.5}, {o:93,h:93.5,l:89,c:90},{o:89.5,h:90,l:87,c:88}], pattern: "Three Inside Down", expectedOutcome: "down" },
             { level: 6, data: [{o:101, h:106, l:100.5, c:105.5}, {o:106,h:110,l:105.5,c:109},{o:109.5,h:112,l:108,c:111}], pattern: "Three Outside Up", expectedOutcome: "up" },
             { level: 6, data: [{o:92, h:92.5, l:88, c:89}, {o:88.5,h:89,l:85,c:86},{o:85.5,h:86,l:83,c:84}], pattern: "Three Outside Down", expectedOutcome: "down" },
             { level: 6, data: [{o:101,h:104,l:100.5,c:103},{o:103.5,h:104,l:100,c:100.5},{o:101,h:103,l:100,c:102}], pattern: "Bullish Stick Sandwich", expectedOutcome: "up" },
            // --- L7 --- (Needs ~0 more for 10 total)
             { level: 7, data: [{o:110,h:110,l:105,c:105},{o:107,h:112,l:107,c:112}], pattern: "Bullish Kicking", expectedOutcome: "up" },
             { level: 7, data: [{o:90,h:95,l:90,c:95},{o:88,h:88,l:83,c:83}], pattern: "Bearish Kicking", expectedOutcome: "down" },
             { level: 7, data: [{o:120,h:121,l:112,c:113}, {o:112,h:115,l:111,c:113.2}], pattern: "On Neck Line", expectedOutcome: "down" },
             { level: 7, data: [{o:130,h:138,l:129.5,c:137}, {o:139,h:140,l:134,c:135}], pattern: "Bullish Thrusting Line", expectedOutcome: "up" },
             { level: 7, data: [{o:108,h:109,l:100,c:101}, {o:103,h:104,l:101.5,c:102}], pattern: "Homing Pigeon", expectedOutcome: "up" },
             { level: 7, data: [{o:107,h:112,l:107,c:112},{o:113,h:115,l:112,c:114}], pattern: "Bullish Kicking", expectedOutcome: "up" },
             { level: 7, data: [{o:88,h:88,l:83,c:83},{o:82,h:83,l:80,c:81}], pattern: "Bearish Kicking", expectedOutcome: "down" },
             { level: 7, data: [{o:112,h:115,l:111,c:113.2},{o:113,h:114,l:110,c:111}], pattern: "On Neck Line", expectedOutcome: "down" },
             { level: 7, data: [{o:139,h:140,l:134,c:135},{o:136,h:138,l:133,c:137}], pattern: "Bullish Thrusting Line", expectedOutcome: "up" },
             { level: 7, data: [{o:103,h:104,l:101.5,c:102},{o:102.5,h:105,l:102,c:104}], pattern: "Homing Pigeon", expectedOutcome: "up" },
            // --- L8 --- (Needs ~0 more for 10 total)
             { level: 8, data: [{o:120,h:128,l:119,c:127},{o:128,h:129,l:126,c:127},{o:126.5,h:127.5,l:125,c:125.5},{o:125,h:126,l:124,c:124.5},{o:125,h:132,l:124.5,c:131}], pattern: "Mat Hold", expectedOutcome: "up" },
             { level: 8, data: [{o:110,h:115,l:109.5,c:114},{o:116,h:120,l:115.5,c:119},{o:119.5,h:123,l:119,c:122}], pattern: "Bullish Side-by-Side White Lines", expectedOutcome: "up" },
             { level: 8, data: [{o:100,h:101,l:95,c:96},{o:93,h:95,l:92.5,c:94.5},{o:94,h:96,l:93.5,c:95.5}], pattern: "Bearish Side-by-Side White Lines", expectedOutcome: "down" },
             { level: 8, data: [{o:105,h:106,l:100,c:101}, {o:102,h:102.5,l:100,c:100.2}], pattern: "Matching Low", expectedOutcome: "up" },
             { level: 8, data: [{o:120,h:125,l:119.5,c:124},{o:124.5,h:125,l:123,c:124.8}], pattern: "Matching High", expectedOutcome: "down" },
             { level: 8, data: [{o:125,h:132,l:124.5,c:131},{o:131.5,h:135,l:130,c:134}], pattern: "Mat Hold", expectedOutcome: "up" },
             { level: 8, data: [{o:119.5,h:123,l:119,c:122},{o:122.5,h:125,l:122,c:124}], pattern: "Bullish Side-by-Side White Lines", expectedOutcome: "up" },
             { level: 8, data: [{o:94,h:96,l:93.5,c:95.5},{o:92,h:93,l:90,c:91}], pattern: "Bearish Side-by-Side White Lines", expectedOutcome: "down" },
             { level: 8, data: [{o:102,h:102.5,l:100,c:100.2},{o:100.5,h:102,l:99,c:101}], pattern: "Matching Low", expectedOutcome: "up" },
             { level: 8, data: [{o:124.5,h:125,l:123,c:124.8},{o:125,h:126,l:123.5,c:124}], pattern: "Matching High", expectedOutcome: "down" },
            // --- L9 --- (Needs ~0 more for 10 total)
             { level: 9, data: [{o:150,h:150,l:140,c:140},{o:140,h:140,l:130,c:130},{o:128,h:132,l:127,c:131},{o:129,h:130,l:125,c:126}], pattern: "Concealing Baby Swallow", expectedOutcome: "up" },
             { level: 9, data: [{o:110,h:111,l:105,c:106},{o:106,h:107,l:101,c:102},{o:102,h:103,l:97,c:98},{o:98,h:102,l:96,c:97},{o:99,h:104,l:98.5,c:103.5}], pattern: "Ladder Bottom", expectedOutcome: "up" },
             { level: 9, data: [{o:105,h:106,l:102,c:103},{o:100,h:101.5,l:99.5,c:100.1},{o:102,h:103,l:101.5,c:102.2}], pattern: "Bullish Tri-Star", expectedOutcome: "up" },
             { level: 9, data: [{o:120,h:124,l:119.5,c:123},{o:125,h:126,l:124.5,c:125.1},{o:123,h:124,l:122.5,c:123.2}], pattern: "Bearish Tri-Star", expectedOutcome: "down" },
             { level: 9, data: [{o:115,h:116,l:108,c:109},{o:110,h:111,l:106,c:107},{o:105,h:107.5,l:104.5,c:106.5}], pattern: "Unique 3 River Bottom", expectedOutcome: "up" },
             { level: 9, data: [{o:129,h:130,l:125,c:126},{o:127,h:130,l:126,c:129}], pattern: "Concealing Baby Swallow", expectedOutcome: "up" },
             { level: 9, data: [{o:99,h:104,l:98.5,c:103.5},{o:104,h:106,l:103,c:105}], pattern: "Ladder Bottom", expectedOutcome: "up" },
             { level: 9, data: [{o:100,h:101.5,l:99.5,c:100.1},{o:102,h:103,l:101.5,c:102.2},{o:102.5,h:104,l:102,c:103.5}], pattern: "Bullish Tri-Star", expectedOutcome: "up" },
             { level: 9, data: [{o:125,h:126,l:124.5,c:125.1},{o:123,h:124,l:122.5,c:123.2},{o:122,h:123,l:120,c:121}], pattern: "Bearish Tri-Star", expectedOutcome: "down" },
             { level: 9, data: [{o:110,h:111,l:106,c:107},{o:105,h:107.5,l:104.5,c:106.5},{o:107,h:109,l:106,c:108}], pattern: "Unique 3 River Bottom", expectedOutcome: "up" },
            // --- L10 --- (Needs ~4 more)
             { level: 10, data: [{o:130,h:138,l:129,c:137},{o:137.5,h:142,l:137,c:141},{o:141.2,h:145,l:140.8,c:143}], pattern: "Advance Block", expectedOutcome: "down"},
             { level: 10, data: [{o:140,h:146,l:139,c:145},{o:145.5,h:150,l:145,c:149},{o:150,h:151.5,l:149.5,c:150.2}], pattern: "Deliberation (Stalled)", expectedOutcome: "down"},
             { level: 10, data: [{o:115,h:120,l:114.5,c:119.5},{o:119,h:119.5,l:115,c:116},{o:115.5,h:120,l:115,c:119.5}], pattern: "Bearish Stick Sandwich", expectedOutcome: "down"},
             { level: 10, data: [{o:100,h:105,l:99.5,c:104},{o:106,h:110,l:105.5,c:109},{o:108,h:109,l:107,c:107.5},{o:107,h:108,l:106,c:106.5},{o:105,h:106,l:100,c:101}], pattern: "Bearish Breakaway", expectedOutcome: "down" },
             { level: 10, data: [{o:100,h:100.5,l:95,c:96},{o:94,h:94.5,l:90,c:91},{o:92,h:94,l:91.5,c:93.5},{o:94,h:96,l:93.5,c:95.5},{o:97,h:102,l:96.5,c:101}], pattern: "Bullish Breakaway", expectedOutcome: "up" },
             { level: 10, data: [{o:137.5,h:142,l:137,c:141},{o:141.2,h:145,l:140.8,c:143},{o:142,h:144,l:140,c:141}], pattern: "Advance Block", expectedOutcome: "down"},
            // --- ADD MORE L10 CHALLENGES HERE ---

            // --- Real Game --- (Needs ~185 more unique scenarios)
            // ... (Include examples using patterns from all levels L1-L10)
            { level: 'real', data: [{o:125,h:126,l:124,c:125},{o:125,h:125.5,l:123,c:123.5},{o:123.5,h:124,l:121,c:122},{o:122,h:123,l:120,c:121},{o:121,h:121.5,l:118,c:119},{o:119,h:120,l:117,c:118},{o:118,h:118.5,l:115,c:116},{o:116,h:117,l:114,c:115},{o:115,h:115.5,l:112,c:113},{o:113,h:114,l:111,c:112},{o:112,h:113,l:108,c:112.5},{o:112.5, h:114, l:106, c:113.5}], pattern: "Hammer", expectedOutcome: "up" },
             { level: 'real', data: [{o:90,h:91,l:89,c:90.5},{o:90.5,h:92,l:90,c:91.5},{o:91.5,h:93,l:91,c:92.8},{o:92.8,h:94,l:92,c:93.5},{o:93.5,h:95,l:93,c:94.8},{o:94.8,h:96,l:94,c:95.2},{o:95.2,h:97,l:95,c:96.5},{o:96.5,h:98,l:96,c:97.8},{o:97.8,h:99,l:97,c:98.2},{o:98.2,h:100,l:98,c:99.5},{o:99.5,h:101,l:99,c:100.2},{o:100.2,h:101.5,l:99.8,c:100.8},{o:100.8,h:101.2,l:98.5,c:99},{o:100,h:100.5,l:95,c:96}], pattern: "Bearish Engulfing", expectedOutcome: "down" },
             { level: 'real', data: [{o:100,h:102,l:99,c:101},{o:101,h:101.5,l:99.5,c:100},{o:100,h:103,l:98,c:102},{o:102,h:103,l:100.5,c:101},{o:101,h:102.5,l:99,c:99.5},{o:99.5,h:101,l:98,c:100.8},{o:100.8,h:102,l:100,c:101.5},{o:101.5,h:102.2,l:100.3,c:100.5},{o:100.5,h:101.8,l:99.8,c:101.2},{o:101.2,h:102.6,l:100.8,c:102},{o:102,h:103,l:101,c:101.8},{o:101.8,h:102.5,l:100,c:100.3},{o:100.3,h:101.5,l:99.5,c:101},{o:101,h:101.8,l:100.2,c:100.5},{o:100.5,h:102.5,l:99.5,c:100.7}], pattern: "Doji", expectedOutcome: "sideways" },
             { level: 'real', data: [{o:130,h:131,l:129,c:130.5},{o:130.5,h:132,l:130,c:131.8},{o:131.8,h:133,l:131,c:132.5},{o:132.5,h:134,l:132,c:133.8},{o:133.8,h:135,l:133,c:134.2},{o:134.2,h:136,l:134,c:135.5},{o:135.5,h:137,l:135,c:136.8},{o:136.8,h:138,l:136,c:137.2},{o:137.2,h:139,l:137,c:138.5},{o:138.5,h:140,l:138,c:139.8},{o:139.8,h:141,l:139,c:140.5},{o:140.5,h:142,l:140,c:141.2},{o:141.2,h:148,l:140.8,c:141.5}], pattern: "Shooting Star", expectedOutcome: "down" },
             { level: 'real', data: [{o:160,h:161,l:159,c:159.5},{o:159.5,h:160,l:157,c:158},{o:158,h:158.5,l:155,c:156},{o:156,h:157,l:154,c:155},{o:155,h:156,l:153,c:153.5},{o:153.5,h:154,l:151,c:152},{o:152,h:153,l:150,c:151},{o:151,h:152,l:149,c:150.5},{o:150.5,h:151,l:148,c:149},{o:149,h:150,l:147,c:148},{o:148,h:148.5,l:146,c:147},{o:147,h:147.5,l:145,c:146},{o:146,h:146.5,l:144,c:145},{o:145,h:145.5,l:143,c:144},{o:144,h:145,l:142,c:143},{o:143,h:144,l:141,c:142}], pattern: "None", expectedOutcome: "down" },
             { level: 'real', data: [{o:115,h:116,l:112,c:113},{o:113,h:114,l:109,c:110},{o:110,h:111,l:106,c:107},{o:107,h:108,l:104,c:105},{o:105,h:106,l:102,c:103}, {o:103,h:104,l:100,c:101}, {o:98,h:99.5,l:97,c:98.5}, {o:100,h:106,l:99.5,c:105}], pattern: "Morning Star", expectedOutcome: "up"},
             { level: 'real', data: [{o:140,h:142,l:139,c:141},{o:141,h:144,l:140,c:143},{o:143,h:146,l:142,c:145},{o:145,h:148,l:144,c:147},{o:147,h:150,l:146,c:149},{o:149,h:152,l:148,c:151},{o:151,h:154,l:150,c:153},{o:153,h:156,l:152,c:155}, {o:155.5, h:157, l:154, c:156}, {o:156.5, h:157, l:153, c:154}], pattern: "Tweezer Tops", expectedOutcome: "down"},
             { level: 'real', data: [{o:120,h:121,l:118,c:119},{o:119,h:119.5,l:115,c:116},{o:116,h:117,l:110,c:111},{o:111.5,h:114,l:111,c:113.5}], pattern: "Bullish Harami", expectedOutcome: "up"},
             { level: 'real', data: [{o:130,h:132,l:129,c:131},{o:131,h:135,l:130.5,c:134},{o:133.5,h:134,l:131.5,c:132},{o:131.8,h:132.2,l:128,c:129}], pattern: "Three Inside Down", expectedOutcome: "down"},
             { level: 'real', data: [{o:115,h:120,l:114,c:119},{o:118,h:119,l:112,c:113},{o:112.5,h:113,l:107,c:108},{o:107.5,h:108,l:102,c:103}, {o:103.5,h:104,l:99,c:100}], pattern: "Three Black Crows", expectedOutcome: "down"},
             { level: 'real', data: [{o:100,h:105,l:99,c:104}, {o:103.5,h:104,l:102,c:102.5}, {o:102,h:103,l:101,c:101.5}, {o:101,h:102,l:100,c:100.5}, {o:101,h:107,l:100.5,c:106}, {o:106.5, h:109, l:106, c:108}], pattern: "Rising Three Methods", expectedOutcome: "up" },
             { level: 'real', data: [{o:110,h:110,l:105,c:105},{o:107,h:112,l:107,c:112}, {o:112.5,h:114,l:111,c:113}], pattern: "Bullish Kicking", expectedOutcome: "up" },
             { level: 'real', data: [{o:105,h:106,l:100,c:101}, {o:102,h:102.5,l:100,c:100.2},{o:100.5, h:101, l:98, c:99}], pattern: "Matching Low", expectedOutcome: "sideways" },
             { level: 'real', data: [{o:140,h:146,l:139,c:145},{o:145.5,h:150,l:145,c:149},{o:150,h:151.5,l:149.5,c:150.2},{o:149,h:150,l:147,c:148}], pattern: "Deliberation (Stalled)", expectedOutcome: "down"},
             { level: 'real', data: [{o:97,h:102,l:96.5,c:101},{o:101.5,h:104,l:101,c:103},{o:103.5,h:106,l:103,c:105.5},{o:105,h:106,l:104,c:104.5},{o:105,h:108,l:104.5,c:107}], pattern: "None", expectedOutcome: "up"},
             { level: 'real', data: [{o:100,h:100.5,l:95,c:96},{o:94,h:94.5,l:90,c:91},{o:92,h:94,l:91.5,c:93.5},{o:94,h:96,l:93.5,c:95.5},{o:97,h:102,l:96.5,c:101},{o:101.5,h:104,l:100,c:103}], pattern: "Bullish Breakaway", expectedOutcome: "up"},
             // --- ADD ~180+ MORE REAL CHALLENGES ---
        ];

        // --- Game State ---
        let currentLevel = 1; let gameMode = 'learning'; let lastLearningLevelVisited = 1;
        let score = 0; let tradingCapital = 10000; let capitalAtSessionStart = 10000;
        let currentStreak = 0; let currentChallenge = null;
        // Score-based learning progression
        let scoreEarnedThisLevel = 0; let maxPossibleScoreThisLevel = 0; let challengesAttemptedThisLevel = 0;
        const minChallengesForLevelPass = 4; // Minimum attempts before checking score %
        const levelPassThreshold = 75; // Percentage needed to pass
        let maxLearningLevel = 10;
        let userPatternGuess = null; let userPredictionGuess = null; let userTermGuess = null;
        let audioEnabled = false; let usedChallengeIndices = {};
        window.lastGeneratedFutureCandles = []; let animationIntervalId = null;

        // --- DOM Element Variables ---
        let gameContainer, levelStatDisplay, scoreDisplay, capitalDisplay, streakDisplay,
            capitalStatSpan, streakStatSpan, // Spans for hiding/showing
            learningLevelDisplay, learningLevelTitle, learningSection, learningContentUl,
            simulatorContainer, simulatorSection, simulatorTitle, chartContainer,
            patternSelect, predictionSelect, termSelect, submitRevealButton, nextChallengeButton,
            feedbackArea, levelInfoSection, levelInfoTitle, levelInstructions,
            challengesNeededSpan, progressBarContainer, levelProgressBar, levelProgressInfo,
            levelScorePercentSpan, // Span for score percentage
            correctChallengesCountSpan, totalChallengesNeededSpan, realGameMessage,
            levelCompleteSection, completedLevelNum, levelFinalScore, levelCapitalChange,
            levelAccuracyPercentSpan, // Span for final level accuracy
            gameCompleteSection, gameCompleteTitle, gameCompleteMessage, finalScoreDisplay,
            finalCapitalDisplay, nextLevelButton, themeToggle, toggleFullscreenBtn,
            skipToTradingSimBtn, backToLearningBtn, skipLevelBtn, prevLevelBtn,
            resizer, soundCorrect, soundIncorrect, soundClick;

        // --- Function Definitions ---
        function playSound(soundElement) { if (audioEnabled && soundElement) { try { soundElement.currentTime = 0; soundElement.play().catch(e => console.warn("Audio fail:", e)); } catch (e) { console.warn("Sound err:", e); } } }
        function enableAudioOnClick() { if (!audioEnabled) { try { audioEnabled = true; const s = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAAABkYXRhAgAAAAEA"); s.play().catch(()=>{}); console.log("Audio enabled."); document.body.removeEventListener('click', enableAudioOnClick, true); document.body.removeEventListener('touchstart', enableAudioOnClick, true); } catch (e) { console.error("Audio init err:", e); audioEnabled = false; } } }
        function getPatternsForLevel(level) { return PATTERNS.filter(p => p.level === level); }
        function getAvailableChallenges(levelOrMode) { const lvl = String(levelOrMode); const allForLevel = CHALLENGES.filter(c => String(c.level) === lvl); if (allForLevel.length === 0) { console.warn(`No challenges for: ${lvl}`); return []; } if (!usedChallengeIndices[lvl]) usedChallengeIndices[lvl] = []; const usedSet = new Set(usedChallengeIndices[lvl]); const items = allForLevel.map(c => ({ challenge: c, originalIndex: CHALLENGES.indexOf(c) })); let available = items.filter(item => !usedSet.has(item.originalIndex)); if (available.length === 0 && allForLevel.length > 0) { console.warn(`Reusing challenges for ${lvl}.`); usedChallengeIndices[lvl] = []; available = items; } return available; }
        function getRandomChallenge(levelOrMode) { try { const items = getAvailableChallenges(levelOrMode); if (items.length === 0) { console.error(`FATAL: No challenges for ${levelOrMode}.`); if(feedbackArea){ feedbackArea.textContent = `Error: No challenges defined for ${levelOrMode}.`; feedbackArea.className='feedback-incorrect visible';} if(submitRevealButton) submitRevealButton.disabled=true; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); return null; } const idx = Math.floor(Math.random() * items.length); const item = items[idx]; usedChallengeIndices[levelOrMode].push(item.originalIndex); console.log(`Selected challenge idx ${item.originalIndex} for ${levelOrMode}. Used:`, usedChallengeIndices[levelOrMode]); return item.challenge; } catch (error) { console.error("Get challenge err:", error); if(feedbackArea){ feedbackArea.textContent = "Error loading challenge."; feedbackArea.className='feedback-incorrect visible';} return null; } }
        function updateProgressBar() { try { if (gameMode === 'learning') { let progressPercent = 0; let currentScorePercent = 0; if (maxPossibleScoreThisLevel > 0) { currentScorePercent = Math.max(0, Math.round((scoreEarnedThisLevel / maxPossibleScoreThisLevel) * 100)); // Actual score %
                    // Progress towards the 75% goal
                    progressPercent = Math.min(100, (currentScorePercent / levelPassThreshold) * 100); } if (levelProgressBar) levelProgressBar.style.width = `${progressPercent}%`; if (progressBarContainer) progressBarContainer.classList.remove('hidden'); if (levelProgressInfo) levelProgressInfo.classList.remove('hidden'); if (levelScorePercentSpan) levelScorePercentSpan.textContent = currentScorePercent; } else { if (progressBarContainer) progressBarContainer.classList.add('hidden'); if (levelProgressInfo) levelProgressInfo.classList.add('hidden'); } } catch (error) { console.error("Progress bar err:", error); } }
        function generateFutureCandles(startCandle, expectedOutcome, numCandles = 10, patternDetails = null) { /* ... Same as previous ... */ try { if (!startCandle || typeof startCandle.c !== 'number' || isNaN(startCandle.c)) { console.error("Invalid start candle:", startCandle); return []; } let futureCandles = []; let lastClose = startCandle.c; let trendFactor = 0; let actualTrend = expectedOutcome; let currentVolatilityFactor = VOLATILITY_FACTOR; let patternSuccessProbability = PATTERN_PROBABILITY; let isPatternIdentified = patternDetails && patternDetails.name !== "None"; if (patternDetails) { switch (patternDetails.strength) { case 'high': patternSuccessProbability = 0.85; break; case 'medium': patternSuccessProbability = 0.75; break; case 'low': patternSuccessProbability = 0.60; break; default: patternSuccessProbability = 0.70; } } else { isPatternIdentified = false; } if (!isPatternIdentified) { if (Math.random() < 0.5) { const outcomes = ['up', 'down', 'sideways'].filter(o => o !== expectedOutcome); actualTrend = outcomes[Math.floor(Math.random() * outcomes.length)]; console.log(`No pattern, expected ${expectedOutcome}, actual ${actualTrend}`); } else { actualTrend = expectedOutcome; console.log(`No pattern, expected ${expectedOutcome}, following expectation.`); } patternSuccessProbability = 0; } else if (Math.random() > patternSuccessProbability) { const outcomes = ['up', 'down', 'sideways'].filter(o => o !== expectedOutcome); actualTrend = outcomes[Math.floor(Math.random() * outcomes.length)]; console.log(`Pattern ${patternDetails?.name} failed prob! Expected ${expectedOutcome}, Actual ${actualTrend}`); } else { console.log(`Pattern ${patternDetails.name} success. Expected ${actualTrend}`); } const baseDrift = 0.0015; let trendDurationFactor = 1.0; let trendMagnitudeFactor = 1.0; if (patternDetails) { switch (patternDetails.term) { case 'short': trendDurationFactor=0.5; trendMagnitudeFactor=1.2; break; case 'short-mid': trendDurationFactor=0.7; trendMagnitudeFactor=1.1; break; case 'mid': trendDurationFactor=0.8; trendMagnitudeFactor=1.0; break; case 'mid-long': trendDurationFactor=1.0; trendMagnitudeFactor=1.3; break; case 'long': trendDurationFactor=1.0; trendMagnitudeFactor=1.5; break; default: trendDurationFactor=0.75; trendMagnitudeFactor=1.0; } } if (actualTrend === 'up') trendFactor = baseDrift * trendMagnitudeFactor; else if (actualTrend === 'down') trendFactor = -baseDrift * trendMagnitudeFactor; else trendFactor = 0; for (let i = 0; i < numCandles; i++) { let open = lastClose; if (isNaN(open)) { console.error(`Open NaN at candle ${i+1}`); break; } let currentTrendInfluence = trendFactor; if (trendDurationFactor < 1.0 && (i / numCandles) > trendDurationFactor) { const fadeProgress = ((i / numCandles) - trendDurationFactor) / (1 - trendDurationFactor); const fade = Math.max(0, 1 - fadeProgress); currentTrendInfluence *= fade; if (Math.random() < 0.15) { console.log(`Trend fade reversal at ${i+1}`); currentTrendInfluence = (Math.random() - 0.5) * baseDrift * 0.5; } } let randomComponent = (Math.random() - 0.5) * 2; let frameVolatility = currentVolatilityFactor; if (Math.random() < 0.08) { console.log(`Vol spike at ${i+1}`); frameVolatility *= (1.5 + Math.random()); } let volComponent = randomComponent * frameVolatility; let change = (currentTrendInfluence + volComponent) * open; let close = open + change; let wickVolatility = Math.random() * open * frameVolatility * 0.8; let high = Math.max(open, close) + wickVolatility; let low = Math.min(open, close) - wickVolatility; high = Math.max(high, open, close); low = Math.min(low, open, close); close = Math.max(low, Math.min(high, close)); if (isNaN(open) || isNaN(high) || isNaN(low) || isNaN(close)) { console.error(`NaN in candle ${i+1} calc`); break; } if (low <= 0.01) { const adjustment = 0.01 - low; low = 0.01; open = Math.max(low, open + adjustment); close = Math.max(low, close + adjustment); high = Math.max(high + adjustment, open, close); console.warn(`Adjusted candle ${i+1} price`); } futureCandles.push({ o: open, h: high, l: low, c: close }); lastClose = close; } console.log("Generated future:", futureCandles.length); return futureCandles; } catch (error) { console.error("Generate future err:", error); return []; } }
        function renderChart(data, container, isExampleChart = false, futureStartIndex = -1) { /* ... Same as previous ... */ try { if (!container) return; container.innerHTML = ''; if (!data || !Array.isArray(data) || data.length === 0) return; const validCandles = data.filter(c => c && typeof c.l === 'number' && !isNaN(c.l) && typeof c.h === 'number' && !isNaN(c.h)); if (validCandles.length === 0) return; const minLow = Math.min(...validCandles.map(c => c.l)); const maxHigh = Math.max(...validCandles.map(c => c.h)); if (isNaN(minLow) || isNaN(maxHigh)) { console.error("RenderChart: Invalid min/max"); return; } let priceRange = maxHigh - minLow; if (priceRange <= 0) priceRange = (maxHigh || 1) * 0.1; const containerHeight = container.clientHeight; if (!containerHeight || containerHeight <= 0) return; const verticalPadding = isExampleChart ? 8 : 15; const availableHeight = containerHeight - verticalPadding; if (availableHeight <= 0) return; const verticalScale = availableHeight / priceRange; const bottomPaddingOffset = verticalPadding / 2; data.forEach((d, index) => { if (!d || typeof d.o !== 'number' || typeof d.h !== 'number' || typeof d.l !== 'number' || typeof d.c !== 'number' || [d.o, d.h, d.l, d.c].some(isNaN)) { console.warn(`Skip invalid candle ${index}`); return; } const { o, h, l, c } = d; const wrap = document.createElement('div'); wrap.className = 'candle-wrapper'; if (futureStartIndex !== -1 && index >= futureStartIndex) wrap.classList.add('future'); const bodyDiv = document.createElement('div'); bodyDiv.className = 'body'; const wickDiv = document.createElement('div'); wickDiv.className = 'wick'; const highPx = (h - minLow) * verticalScale; const lowPx = (l - minLow) * verticalScale; const openPx = (o - minLow) * verticalScale; const closePx = (c - minLow) * verticalScale; const wickHeight = Math.max(1, highPx - lowPx); wickDiv.style.height = `${wickHeight}px`; wickDiv.style.bottom = `${Math.max(0, lowPx + bottomPaddingOffset)}px`; const bodyTopPx = Math.max(openPx, closePx); const bodyBottomPx = Math.min(openPx, closePx); let bodyHeight = Math.max(1, bodyTopPx - bodyBottomPx); bodyDiv.style.height = `${bodyHeight}px`; bodyDiv.style.bottom = `${Math.max(0, bodyBottomPx + bottomPaddingOffset)}px`; const bodySize = Math.abs(o - c); const totalRange = h - l; const isDoji = (totalRange > 0 && (bodySize / totalRange) < 0.05) || bodySize < (priceRange * 0.01); if (isDoji) { wrap.classList.add('doji'); bodyHeight = 1.5; bodyDiv.style.height = `${bodyHeight}px`; const avgPx = ((openPx + closePx) / 2); bodyDiv.style.bottom = `${Math.max(0, avgPx + bottomPaddingOffset - (bodyHeight / 2))}px`; } else if (c > o) { wrap.classList.add('bullish'); } else if (c < o) { wrap.classList.add('bearish'); } wrap.appendChild(wickDiv); wrap.appendChild(bodyDiv); container.appendChild(wrap); }); } catch (error) { console.error("Render chart err:", error); if(container) container.innerHTML = '<p style="color:red;">Chart Err</p>'; } }
        function renderPatternExample(patternData, containerElement) { /* ... Same as previous ... */ try { if (!patternData || !patternData.example || patternData.example.length === 0 || !containerElement) return; const max = 5; const data = patternData.example.slice(-max); if (containerElement.clientHeight > 0 && containerElement.clientWidth > 0) { renderChart(data, containerElement, true); } else { setTimeout(() => { if (containerElement.clientHeight > 0 && containerElement.clientWidth > 0) renderChart(data, containerElement, true); }, 150); } } catch (error) { console.error("Example render err:", patternData?.name, error); if(containerElement) containerElement.innerHTML = '<small style="color:red;">Err</small>'; } }
        function startTradingSimulator() { try { playSound(soundClick); gameMode = 'real'; currentLevel = 'Trading Sim'; console.log("--- Starting Trading Simulator ---"); if (levelStatDisplay) levelStatDisplay.textContent = "Mode: Trading Sim"; if (capitalStatSpan) capitalStatSpan.classList.remove('hidden'); if (streakStatSpan) streakStatSpan.classList.remove('hidden'); if (learningSection) learningSection.classList.add('hidden'); if (resizer) resizer.classList.add('hidden'); if (gameContainer) gameContainer.classList.add('real-game-mode'); if (skipToTradingSimBtn) skipToTradingSimBtn.classList.add('hidden'); if (backToLearningBtn) backToLearningBtn.classList.remove('hidden'); if (skipLevelBtn) skipLevelBtn.classList.add('hidden'); if (prevLevelBtn) prevLevelBtn.classList.add('hidden'); if (levelInfoTitle) levelInfoTitle.textContent = "Trading Simulator"; if (levelInstructions) levelInstructions.classList.add('hidden'); if (realGameMessage) realGameMessage.classList.remove('hidden'); if (progressBarContainer) progressBarContainer.classList.add('hidden'); if (levelProgressInfo) levelProgressInfo.classList.add('hidden'); if (simulatorTitle) simulatorTitle.textContent = "Trading Simulator Challenge"; capitalAtSessionStart = tradingCapital; if (patternSelect) { patternSelect.innerHTML = '<option value="">-- Select Pattern --</option>'; PATTERNS.forEach(p => { const opt = document.createElement('option'); opt.value = p.name; opt.textContent = `${p.name} (L${p.level})`; patternSelect.appendChild(opt); }); const noneOpt = document.createElement('option'); noneOpt.value = "None"; noneOpt.textContent = "None"; patternSelect.appendChild(noneOpt); } else console.error("Pattern select missing"); if(feedbackArea) { feedbackArea.classList.remove('visible'); feedbackArea.className = ''; } if(submitRevealButton) submitRevealButton.disabled = false; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); if(patternSelect) patternSelect.disabled = false; if(predictionSelect) predictionSelect.disabled = false; if(termSelect) termSelect.disabled = false; if (!usedChallengeIndices['real']) usedChallengeIndices['real'] = []; generateChallenge(); } catch (error) { console.error("Start sim err:", error); if(feedbackArea){ feedbackArea.textContent = "Error starting Simulator."; feedbackArea.className = 'feedback-incorrect visible';} } }
        function loadLevel(level) { if (level < 1 || level > maxLearningLevel) { console.error(`Invalid level: ${level}`); return; } console.log(`--- Loading Level: ${level} ---`); try { playSound(soundClick); gameMode = 'learning'; currentLevel = level; lastLearningLevelVisited = level; if(gameContainer) gameContainer.classList.remove('real-game-mode'); if (skipToTradingSimBtn) skipToTradingSimBtn.classList.remove('hidden'); if (backToLearningBtn) backToLearningBtn.classList.add('hidden'); if (capitalStatSpan) capitalStatSpan.classList.add('hidden'); if (streakStatSpan) streakStatSpan.classList.add('hidden'); if (levelStatDisplay) levelStatDisplay.textContent = `Level: ${level}`; if (learningSection) learningSection.classList.remove('hidden'); if (resizer) resizer.classList.remove('hidden'); if (skipLevelBtn) { if (currentLevel < maxLearningLevel) skipLevelBtn.classList.remove('hidden'); else skipLevelBtn.classList.add('hidden'); } if (prevLevelBtn) { if (currentLevel > 1) prevLevelBtn.classList.remove('hidden'); else prevLevelBtn.classList.add('hidden'); } if (levelInfoTitle) levelInfoTitle.textContent = `Level ${level} Focus`; if (levelInstructions) levelInstructions.classList.remove('hidden'); if (realGameMessage) realGameMessage.classList.add('hidden'); if (progressBarContainer) progressBarContainer.classList.remove('hidden'); if (levelProgressInfo) levelProgressInfo.classList.remove('hidden'); if (simulatorTitle) simulatorTitle.textContent = "Learning Challenge"; if(learningLevelDisplay) learningLevelDisplay.textContent = level; if(learningLevelTitle) learningLevelTitle.textContent = level; if(feedbackArea) { feedbackArea.classList.remove('visible'); feedbackArea.className = ''; } if(levelCompleteSection) levelCompleteSection.classList.add('hidden'); if(gameCompleteSection) gameCompleteSection.classList.add('hidden'); if(submitRevealButton) submitRevealButton.disabled = false; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); scoreEarnedThisLevel = 0; maxPossibleScoreThisLevel = 0; challengesAttemptedThisLevel = 0; const levelPatterns = getPatternsForLevel(level); if (learningContentUl) { learningContentUl.innerHTML = ''; levelPatterns.forEach(p => { try { const li = document.createElement('li'); li.innerHTML = `<div class="pattern-description"><strong>${p.name} (${p.candles}c)</strong><span class="pattern-type">${p.type} (${p.term}, ${p.strength})</span><p>${p.desc || 'No desc.'}</p></div><div class="pattern-example-chart-container"><small>Ex:</small><div class="pattern-example-chart" id="example-${p.name.replace(/\s+/g, '-')}"></div></div>`; learningContentUl.appendChild(li); const cont = li.querySelector('.pattern-example-chart'); requestAnimationFrame(() => renderPatternExample(p, cont)); } catch (e) { console.error("Learning item err:", p.name, e);} }); if (levelPatterns.length === 0) learningContentUl.innerHTML = `<li><p><em>No patterns for Level ${level}.</em></p></li>`; } else { console.error("Learning UL missing") } if(patternSelect) { patternSelect.innerHTML = '<option value="">-- Select Pattern --</option>'; levelPatterns.forEach(p => { const opt = document.createElement('option'); opt.value = p.name; opt.textContent = p.name; patternSelect.appendChild(opt); }); const noneOpt = document.createElement('option'); noneOpt.value = "None"; noneOpt.textContent = "None"; patternSelect.appendChild(noneOpt); if (levelPatterns.length === 0) { patternSelect.innerHTML = '<option value="">-- No Patterns --</option>'; patternSelect.disabled = true; } else { patternSelect.disabled = false; } } else { console.error("Pattern select missing."); } if(predictionSelect) { predictionSelect.options[0].textContent = "-- Select Trend --"; predictionSelect.disabled = (levelPatterns.length === 0); } if(termSelect) { termSelect.value = ""; termSelect.disabled = (levelPatterns.length === 0); } if (!usedChallengeIndices[currentLevel]) usedChallengeIndices[currentLevel] = []; updateProgressBar(); if (levelPatterns.length > 0) { generateChallenge(); } else { if(feedbackArea){ feedbackArea.textContent = `No patterns/challenges for level ${level}.`; feedbackArea.className = 'visible';} if(submitRevealButton) submitRevealButton.disabled = true; } } catch (error) { console.error("Load level err:", level, error); if(feedbackArea){ feedbackArea.textContent = `Error loading level ${level}.`; feedbackArea.className = 'feedback-incorrect visible';} if (submitRevealButton) submitRevealButton.disabled = true; } }
        function generateChallenge() { /* ... Same as previous ... */ const levelOrMode = gameMode === 'real' ? 'real' : currentLevel; console.log(`Generating challenge for ${levelOrMode}`); try { if (animationIntervalId) { clearInterval(animationIntervalId); animationIntervalId = null; } currentChallenge = getRandomChallenge(levelOrMode); if (!currentChallenge) { console.error("Generate challenge failed: No challenge returned."); return; } if (!currentChallenge.data || !Array.isArray(currentChallenge.data) || currentChallenge.data.length === 0) { console.error("Invalid challenge data:", currentChallenge); if(feedbackArea){ feedbackArea.textContent = "Error: Invalid data loaded."; feedbackArea.className = 'feedback-incorrect visible';} setTimeout(generateChallenge, 100); return; } if(patternSelect) patternSelect.value = ""; if(predictionSelect) predictionSelect.value = ""; if(termSelect) termSelect.value = ""; if(submitRevealButton) submitRevealButton.disabled = false; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); if(feedbackArea) { feedbackArea.classList.remove('visible'); feedbackArea.className = ''; } if(patternSelect) patternSelect.disabled = false; if(predictionSelect) predictionSelect.disabled = false; if(termSelect) termSelect.disabled = false; userPatternGuess = null; userPredictionGuess = null; userTermGuess = null; window.lastGeneratedFutureCandles = []; requestAnimationFrame(() => { if (chartContainer) { renderChart(currentChallenge.data, chartContainer, false, -1); } else { console.error("Chart container missing."); } }); } catch (error) { console.error("Generate challenge err:", error); if(feedbackArea){ feedbackArea.textContent = "Error generating challenge."; feedbackArea.className = 'feedback-incorrect visible';} if(submitRevealButton) submitRevealButton.disabled = true; } }
        function handleSubmitAndReveal() { /* ... Now generates 50 candles always ... */ console.log("Submit triggered."); try { if (animationIntervalId) { clearInterval(animationIntervalId); animationIntervalId = null; } playSound(soundClick); userPatternGuess = patternSelect?.value; userPredictionGuess = predictionSelect?.value; userTermGuess = termSelect?.value; if (!userPatternGuess || !userPredictionGuess || !userTermGuess) { if(feedbackArea){ feedbackArea.textContent = "Select Pattern, Trend, and Term."; feedbackArea.className = 'feedback-incorrect visible';} return; } console.log(`Guess: P=${userPatternGuess}, Pr=${userPredictionGuess}, T=${userTermGuess}`); if(submitRevealButton) submitRevealButton.disabled = true; if(patternSelect) patternSelect.disabled = true; if(predictionSelect) predictionSelect.disabled = true; if(termSelect) termSelect.disabled = true; if(feedbackArea) feedbackArea.classList.remove('visible'); if (!currentChallenge?.data?.length) { console.error("Submit Err: No challenge data."); if(feedbackArea){ feedbackArea.textContent = "Error: Cannot process."; feedbackArea.className = 'feedback-incorrect visible';} return; } const historicData = [...currentChallenge.data]; const lastHistoric = historicData[historicData.length - 1]; const actualPatternObj = PATTERNS.find(p => p.name === currentChallenge.pattern) || { name: "None", strength: 'low', term: 'mid', type: 'n/a' }; const candlesToGenerate = 50; // ALWAYS generate 50 candles now
            window.lastGeneratedFutureCandles = generateFutureCandles(lastHistoric, currentChallenge.expectedOutcome, candlesToGenerate, actualPatternObj); if (!window.lastGeneratedFutureCandles || window.lastGeneratedFutureCandles.length === 0) { console.error("Future gen failed."); if(feedbackArea){ feedbackArea.textContent = "Error generating future data."; feedbackArea.className = 'feedback-incorrect visible';} if(nextChallengeButton) nextChallengeButton.classList.remove('hidden'); return; } let candlesToShow = [...historicData]; const queue = [...window.lastGeneratedFutureCandles]; const futureStartIdx = historicData.length; const speedMs = gameMode === 'real' ? 100 : 150; // Slightly slower for learning 50 candles
            console.log(`Starting animation (${candlesToGenerate} candles)...`); animationIntervalId = setInterval(() => { if (queue.length === 0) { clearInterval(animationIntervalId); animationIntervalId = null; console.log("Animation finished."); evaluateOutcomeAndGiveFeedback(); } else { const next = queue.shift(); candlesToShow.push(next); requestAnimationFrame(() => { if (chartContainer) { renderChart(candlesToShow, chartContainer, false, futureStartIdx); } }); } }, speedMs); } catch (error) { console.error("Submit/reveal err:", error); if (animationIntervalId) clearInterval(animationIntervalId); if(feedbackArea){ feedbackArea.textContent = "Processing error."; feedbackArea.className = 'feedback-incorrect visible';} if(nextChallengeButton) nextChallengeButton.classList.remove('hidden'); } }
        function evaluateOutcomeAndGiveFeedback() { /* ... Updated scoring, term calc, learning progression ... */ try { console.log("Evaluating outcome..."); if (!currentChallenge || !window.lastGeneratedFutureCandles || window.lastGeneratedFutureCandles.length < 50) { console.error("Eval Err: Missing or incomplete data (<50 future)."); if(feedbackArea){ feedbackArea.textContent = "Error evaluating."; feedbackArea.className = 'feedback-incorrect visible';} if(nextChallengeButton) nextChallengeButton.classList.remove('hidden'); return; } const lastHistoric = currentChallenge.data[currentChallenge.data.length - 1]; const startPrice = lastHistoric?.c; const endPrice = window.lastGeneratedFutureCandles[window.lastGeneratedFutureCandles.length - 1]?.c; let actualOutcome = "sideways"; const threshFactor = 0.01; if (typeof startPrice === 'number' && typeof endPrice === 'number' && !isNaN(startPrice) && !isNaN(endPrice)) { const change = endPrice - startPrice; const threshold = startPrice * threshFactor; if (change > threshold) actualOutcome = "up"; else if (change < -threshold) actualOutcome = "down"; console.log(`Outcome: Start=${startPrice.toFixed(2)}, End=${endPrice.toFixed(2)}, Actual=${actualOutcome}`); } else { console.warn("Invalid price data.", {startPrice, endPrice}); actualOutcome = "unknown"; }
            const correctPatternName = currentChallenge.pattern || "None";
            // --- Calculate Actual Term based on future candles ---
            let calculatedActualTerm = 'short'; // Default
            if(window.lastGeneratedFutureCandles.length > 0 && actualOutcome !== 'sideways' && actualOutcome !== 'unknown') {
                let peakIndex = -1; let peakValue = (actualOutcome === 'up') ? startPrice : -Infinity; let troughValue = (actualOutcome === 'down') ? startPrice : Infinity;
                 if (actualOutcome === 'up') { peakValue = startPrice; window.lastGeneratedFutureCandles.forEach((c, i) => { if (c.h > peakValue) { peakValue = c.h; peakIndex = i; } }); }
                 else { troughValue = startPrice; window.lastGeneratedFutureCandles.forEach((c, i) => { if (c.l < troughValue) { troughValue = c.l; peakIndex = i; } }); }
                if (peakIndex >= 0 && peakIndex <= 14) calculatedActualTerm = 'short';
                else if (peakIndex >= 15 && peakIndex <= 34) calculatedActualTerm = 'mid';
                else if (peakIndex >= 35) calculatedActualTerm = 'long';
                console.log(`Calculated Term: Peak/Trough Idx=${peakIndex}, Term=${calculatedActualTerm}`);
            } else { console.log("Cannot calculate term for sideways/unknown outcome."); calculatedActualTerm = 'n/a'; } // Indicate term N/A
            // --- Scoring ---
            let isPatternCorrect = (userPatternGuess === correctPatternName);
            let isPredictionCorrect = (userPredictionGuess === actualOutcome && actualOutcome !== 'unknown');
            let isTermCorrect = (userTermGuess === calculatedActualTerm && calculatedActualTerm !== 'n/a');
            let pointsEarned = 0; let capitalChange = 0; const riskFactor = 0.015;
            const maxPointsPerChallenge = 10; // 4(pat) + 4(trend) + 2(term)
            pointsEarned += isPatternCorrect ? 4 : -2; pointsEarned += isPredictionCorrect ? 4 : -2; pointsEarned += isTermCorrect ? 2 : -1;
            if (gameMode === 'real') { // Only calc capital change in sim mode
                if (actualOutcome !== 'unknown') { let winMult = 1.5; let lossMult = 1.0; if (isPatternCorrect && isPredictionCorrect && isTermCorrect) winMult = 2.0; capitalChange = isPredictionCorrect ? Math.round(tradingCapital * riskFactor * winMult) : -Math.round(tradingCapital * riskFactor * lossMult); } else { capitalChange = 0; }
            }
            // --- Feedback Message ---
            let msg = `Ptn: <strong>${correctPatternName}</strong> `; msg += isPatternCorrect ? `<span class="feedback-icon ok">&#10004;</span> ` : `<span class="feedback-icon err">&#10006;</span> `;
            msg += `| Trend: <strong>${actualOutcome.toUpperCase()}</strong> `; if (actualOutcome !== 'unknown') { msg += isPredictionCorrect ? `<span class="feedback-icon ok">&#10004;</span> ` : `<span class="feedback-icon err">&#10006;</span> `; } else { msg += ` <span style='color: orange;'>(?)</span> `; }
            msg += `| Term: <strong>${calculatedActualTerm.toUpperCase()}</strong> `; msg += isTermCorrect ? `<span class="feedback-icon ok">&#10004;</span> ` : `<span class="feedback-icon err">&#10006;</span> `;
            msg += `| Pts: ${pointsEarned > 0 ? '+' : ''}${pointsEarned} `;
            if (gameMode === 'real') msg += `| Cap: ${capitalChange >= 0 ? '+' : ''}${capitalChange.toLocaleString()} `;

            // --- Update State & UI ---
            score += pointsEarned; // Update global score
            if (gameMode === 'learning') { scoreEarnedThisLevel += pointsEarned; maxPossibleScoreThisLevel += maxPointsPerChallenge; challengesAttemptedThisLevel++; }
            else { tradingCapital += capitalChange; } // Apply capital change only in real mode
            if (gameMode === 'real') { // Only update streak in real mode
                 if (isPredictionCorrect) { currentStreak++; playSound(soundCorrect); } else { currentStreak = 0; playSound(soundIncorrect); }
                 if(streakDisplay) streakDisplay.innerHTML = `Streak: <span id="current-streak">${currentStreak}</span> &#x1F525;`;
                 if(capitalDisplay) capitalDisplay.textContent = tradingCapital.toLocaleString();
            } else { playSound(isPatternCorrect && isPredictionCorrect && isTermCorrect ? soundCorrect : soundIncorrect); } // Play sound based on overall correctness in learning
            if(scoreDisplay) scoreDisplay.textContent = score;
            if(feedbackArea) { feedbackArea.innerHTML = msg; feedbackArea.className = (pointsEarned > 0) ? 'feedback-correct visible' : 'feedback-incorrect visible'; } // Green if any points gained
            updateProgressBar();
            // --- Check Game/Level End State ---
            if (tradingCapital <= 0 && gameMode === 'real') { handleBankruptcy(); }
            else if (gameMode === 'learning' && challengesAttemptedThisLevel >= minChallengesForLevelPass && maxPossibleScoreThisLevel > 0 && (scoreEarnedThisLevel / maxPossibleScoreThisLevel * 100) >= levelPassThreshold) { handleLevelCompletion(); }
            else { if(nextChallengeButton) nextChallengeButton.classList.remove('hidden'); } } catch (error) { console.error("Outcome eval err:", error); if(feedbackArea){ feedbackArea.textContent = "Error evaluating results."; feedbackArea.className = 'feedback-incorrect visible';} if(nextChallengeButton) nextChallengeButton.classList.remove('hidden'); } }
        function handleLevelCompletion() { /* ... Updated message ... */ try { if (gameMode !== 'learning') return; console.log(`--- Level ${currentLevel} Mastered! ---`); playSound(soundCorrect); if(levelCompleteSection) levelCompleteSection.classList.remove('hidden'); if(completedLevelNum) completedLevelNum.textContent = currentLevel; if(levelFinalScore) levelFinalScore.textContent = score; const accuracy = maxPossibleScoreThisLevel > 0 ? Math.round((scoreEarnedThisLevel / maxPossibleScoreThisLevel) * 100) : 0; if(levelAccuracyPercentSpan) levelAccuracyPercentSpan.textContent = accuracy; if (currentLevel < maxLearningLevel) { if(nextLevelButton) { nextLevelButton.textContent = `Start Level ${currentLevel + 1}`; nextLevelButton.onclick = handleNextLevel; } } else { if(nextLevelButton) { nextLevelButton.textContent = 'Start Trading Simulator!'; nextLevelButton.onclick = () => { playSound(soundClick); if(levelCompleteSection) levelCompleteSection.classList.add('hidden'); startTradingSimulator(); }; } } if(submitRevealButton) submitRevealButton.disabled = true; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); if(patternSelect) patternSelect.disabled = true; if(predictionSelect) predictionSelect.disabled = true; if(termSelect) termSelect.disabled = true; if(feedbackArea) feedbackArea.classList.remove('visible'); if(skipLevelBtn) skipLevelBtn.classList.add('hidden'); if(prevLevelBtn) prevLevelBtn.classList.add('hidden'); } catch (error) { console.error("Level complete err:", error); if(levelCompleteSection) { levelCompleteSection.innerHTML = "<p>Error results.</p><button onclick='location.reload()'>Refresh</button>"; levelCompleteSection?.classList.remove('hidden'); } } }
        function handleBankruptcy() { /* ... Same as previous ... */ try { playSound(soundIncorrect); console.log("--- BANKRUPTCY! ---"); if (animationIntervalId) { clearInterval(animationIntervalId); animationIntervalId = null; } if(feedbackArea && !feedbackArea.innerHTML.includes("BANKRUPT")) feedbackArea.innerHTML += `<br><strong class="bankrupt-message">BANKRUPT! Game Over.</strong>`; if(feedbackArea){ feedbackArea.classList.remove('feedback-correct'); feedbackArea.classList.add('feedback-incorrect', 'visible');} if(submitRevealButton) submitRevealButton.disabled = true; if(nextChallengeButton) nextChallengeButton.classList.add('hidden'); if(patternSelect) patternSelect.disabled = true; if(predictionSelect) predictionSelect.disabled = true; if(termSelect) termSelect.disabled = true; if(skipToTradingSimBtn) skipToTradingSimBtn.disabled = true; if(backToLearningBtn) backToLearningBtn.disabled = true; if(skipLevelBtn) skipLevelBtn.disabled = true; if(prevLevelBtn) prevLevelBtn.disabled = true; if(toggleFullscreenBtn) toggleFullscreenBtn.disabled = true; if(gameCompleteSection) { gameCompleteSection.classList.remove('hidden'); if(gameCompleteTitle) { gameCompleteTitle.textContent = "Bankrupt! Trading Over!"; gameCompleteTitle.style.color = 'var(--bearish-color)'; } if(gameCompleteMessage && finalScoreDisplay && finalCapitalDisplay) { finalScoreDisplay.textContent = score; finalCapitalDisplay.textContent = tradingCapital.toLocaleString(); gameCompleteMessage.innerHTML = `Final Score: <span id="final-score">${score}</span> | Final Capital: $<span id="final-capital">${tradingCapital.toLocaleString()}</span> <br> <span class='bankrupt-message'>Capital reached zero.</span>`; } } if(levelCompleteSection) levelCompleteSection.classList.add('hidden'); if(levelInfoSection) levelInfoSection.classList.add('hidden'); if (learningSection) learningSection.classList.add('hidden'); if (resizer) resizer.classList.add('hidden'); if (gameContainer) gameContainer.classList.add('real-game-mode'); } catch (error) { console.error("Bankruptcy err:", error); alert("Game Over - Bankrupt!"); } }
        function handleNextChallenge() { /* ... Same as previous ... */ try { playSound(soundClick); if (animationIntervalId) clearInterval(animationIntervalId); generateChallenge(); } catch (error) { console.error("Next challenge err:", error); if(feedbackArea){ feedbackArea.textContent = "Error loading next."; feedbackArea.className = 'feedback-incorrect visible';} } }
        function handleNextLevel() { /* ... Same as previous ... */ try { playSound(soundClick); if (gameMode === 'learning' && currentLevel < maxLearningLevel) loadLevel(currentLevel + 1); else { console.warn("Next level called unexpectedly."); startTradingSimulator(); } if(levelCompleteSection) levelCompleteSection.classList.add('hidden'); } catch (error) { console.error("Next level err:", error); if(feedbackArea){ feedbackArea.textContent = "Error proceeding."; feedbackArea.className = 'feedback-incorrect visible';} } }
        function handleSkipLevel() { /* ... Same as previous ... */ try { playSound(soundClick); if (gameMode === 'learning' && currentLevel < maxLearningLevel) { console.log(`Skipping L${currentLevel} to L${currentLevel + 1}`); loadLevel(currentLevel + 1); } else if (gameMode === 'learning' && currentLevel === maxLearningLevel) { console.log(`Skipping final L${currentLevel} to Trading Simulator`); startTradingSimulator(); } } catch (error) { console.error("Skip level err:", error); } }
        function handleBackToLearning() { /* ... Same as previous ... */ try { playSound(soundClick); if (gameMode === 'real') { console.log(`Back to learning L${lastLearningLevelVisited}`); loadLevel(lastLearningLevelVisited); } } catch (error) { console.error("Back to learning err:", error); } }
        function handlePrevLevel() { /* ... Same as previous ... */ try { playSound(soundClick); if (gameMode === 'learning' && currentLevel > 1) { console.log(`Back to previous level ${currentLevel - 1}`); loadLevel(currentLevel - 1); } } catch (error) { console.error("Prev level err:", error); } }
        function applyTheme(theme) { /* ... Same as previous ... */ try { const isDark = theme === 'dark'; document.body.classList.toggle('dark-theme', isDark); if(themeToggle) themeToggle.checked = isDark; requestAnimationFrame(() => { try { const txtColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(); const arrowColor = encodeURIComponent(txtColor || (isDark ? '#E9ECEF' : '#212529')); const svgUrl = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22${arrowColor}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E')`; if (patternSelect) patternSelect.style.backgroundImage = svgUrl; if (predictionSelect) predictionSelect.style.backgroundImage = svgUrl; if(termSelect) termSelect.style.backgroundImage = svgUrl; } catch (svgErr) { console.error("SVG arrow err:", svgErr); } if (chartContainer && currentChallenge && chartContainer.offsetParent !== null) { let data = currentChallenge.data; let futureIdx = -1; if (submitRevealButton?.disabled && window.lastGeneratedFutureCandles.length > 0) { data = [...currentChallenge.data, ...window.lastGeneratedFutureCandles]; futureIdx = currentChallenge.data.length; } renderChart(data, chartContainer, false, futureIdx); } if (gameMode === 'learning' && learningContentUl && !learningSection.classList.contains('hidden') && learningContentUl.offsetParent !== null) { learningContentUl.querySelectorAll('.pattern-example-chart').forEach(div => { const name = div.id.replace('example-', '').replace(/-/g, ' '); const pData = PATTERNS.find(p => p.name === name); if(pData && div.clientHeight > 0) renderPatternExample(pData, div); }); } }); } catch (error) { console.error("Theme err:", error); } }
        function toggleFullScreen() { /* ... Same as previous ... */ try { playSound(soundClick); const elem = simulatorContainer; if (!elem) return; if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.error(`FS Err: ${err.message}`, err)); else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen(); else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); else if (elem.msRequestFullscreen) elem.msRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen().catch(err => console.error("Exit FS Err:", err)); else if (document.mozCancelFullScreen) document.mozCancelFullScreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); } } catch (error) { console.error("FS toggle err:", error); } }
        function handleFullscreenChange() { /* ... Same as previous ... */ try { const isFS = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement); if (toggleFullscreenBtn) toggleFullscreenBtn.textContent = isFS ? 'Exit Fullscreen' : 'Fullscreen'; requestAnimationFrame(() => { if (currentChallenge && chartContainer && chartContainer.offsetParent !== null) { let data = currentChallenge.data; let idx = -1; if (submitRevealButton?.disabled && window.lastGeneratedFutureCandles.length > 0) { data = [...currentChallenge.data, ...window.lastGeneratedFutureCandles]; idx = currentChallenge.data.length; } renderChart(data, chartContainer, false, idx); } }); } catch (error) { console.error("FS change err:", error); } }
        function initResizer() { /* ... Same as previous ... */ if (!resizer || !learningSection || !simulatorContainer || !gameContainer) { console.warn("Resizer elements missing."); return; } let isResizing = false; let startX, startWidth; try { const savedWidth = localStorage.getItem('learningSectionWidth'); if (savedWidth && learningSection && !learningSection.classList.contains('hidden')) { const widthPx = parseInt(savedWidth, 10); if (!isNaN(widthPx) && widthPx > 50) learningSection.style.flexBasis = `${widthPx}px`; } } catch (e) { console.error("Load width err:", e); } resizer.addEventListener('mousedown', (e) => { if (learningSection.classList.contains('hidden') || getComputedStyle(learningSection).display === 'none') return; isResizing = true; startX = e.clientX; startWidth = learningSection.offsetWidth; resizer.classList.add('resizing'); document.body.style.cursor = 'ew-resize'; document.body.style.userSelect = 'none'; document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); }); function handleMouseMove(e) { if (!isResizing) return; const currentX = e.clientX; const diffX = currentX - startX; let newWidth = startWidth + diffX; try { const minW = parseInt(getComputedStyle(learningSection).minWidth, 10) || 150; const contW = gameContainer.offsetWidth; const resStyle = getComputedStyle(resizer); const resTotalW = resizer.offsetWidth + parseInt(resStyle.marginLeft, 10) + parseInt(resStyle.marginRight, 10); const simMinW = parseInt(getComputedStyle(simulatorContainer).minWidth, 10) || 300; const contPad = parseInt(getComputedStyle(gameContainer).paddingLeft, 10) + parseInt(getComputedStyle(gameContainer).paddingRight, 10); const maxW = contW - simMinW - resTotalW - contPad - 5; newWidth = Math.max(minW, Math.min(newWidth, maxW)); learningSection.style.flexBasis = `${newWidth}px`; } catch (err) { console.error("Resize err:", err); handleMouseUp(); } } function handleMouseUp() { if (isResizing) { isResizing = false; resizer.classList.remove('resizing'); document.body.style.cursor = 'default'; document.body.style.userSelect = ''; document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); try { if (learningSection.offsetWidth > 0) localStorage.setItem('learningSectionWidth', learningSection.offsetWidth); } catch (e) { console.error("Save width err:", e); } requestAnimationFrame(() => { if (chartContainer && currentChallenge && chartContainer.offsetParent !== null) { let data = currentChallenge.data; let idx = -1; if (submitRevealButton?.disabled && window.lastGeneratedFutureCandles.length > 0) { data = [...currentChallenge.data, ...window.lastGeneratedFutureCandles]; idx = currentChallenge.data.length; } renderChart(data, chartContainer, false, idx); } if (gameMode === 'learning' && learningContentUl && learningContentUl.offsetParent !== null) { learningContentUl.querySelectorAll('.pattern-example-chart').forEach(div => { const name = div.id.replace('example-', '').replace(/-/g, ' '); const pData = PATTERNS.find(p => p.name === name); if(pData && div.clientHeight > 0) renderPatternExample(pData, div); }); } }); } } }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Initializing...");
            // --- Assign DOM Elements ---
            gameContainer=document.getElementById('game-container'); levelStatDisplay=document.getElementById('level-stat'); scoreDisplay=document.getElementById('current-score'); capitalDisplay=document.getElementById('trading-capital'); streakDisplay=document.getElementById('streak-display'); capitalStatSpan=document.getElementById('capital-stat'); streakStatSpan=document.getElementById('streak-stat'); learningLevelDisplay=document.getElementById('learning-level'); learningLevelTitle=document.getElementById('learning-level-title'); learningSection=document.getElementById('learning-section'); learningContentUl=document.querySelector('#learning-content ul'); simulatorContainer=document.getElementById('simulator-container'); simulatorSection=document.getElementById('simulator-section'); simulatorTitle=document.getElementById('simulator-title'); chartContainer=document.getElementById('chart-container'); patternSelect=document.getElementById('pattern-select'); predictionSelect=document.getElementById('prediction-select'); termSelect=document.getElementById('term-select'); submitRevealButton=document.getElementById('submit-reveal-button'); nextChallengeButton=document.getElementById('next-challenge-button'); feedbackArea=document.getElementById('feedback-area'); levelInfoSection=document.getElementById('level-info'); levelInfoTitle=document.getElementById('level-info-title'); levelInstructions=document.getElementById('level-instructions'); challengesNeededSpan=document.getElementById('challenges-needed'); progressBarContainer=document.querySelector('.progress-bar-container'); levelProgressBar=document.getElementById('level-progress-bar'); levelProgressInfo=document.getElementById('level-progress-info'); levelScorePercentSpan=document.getElementById('level-score-percent'); correctChallengesCountSpan=document.getElementById('correct-challenges-count'); totalChallengesNeededSpan=document.getElementById('total-challenges-needed'); realGameMessage=document.getElementById('real-game-message'); levelCompleteSection=document.getElementById('level-complete'); completedLevelNum=document.getElementById('completed-level-num'); levelFinalScore=document.getElementById('level-final-score'); levelCapitalChange=document.getElementById('level-capital-change'); levelAccuracyPercentSpan=document.getElementById('level-accuracy-percent'); gameCompleteSection=document.getElementById('game-complete'); gameCompleteTitle=document.getElementById('game-complete-title'); gameCompleteMessage=document.getElementById('game-complete-message'); finalScoreDisplay=document.getElementById('final-score'); finalCapitalDisplay=document.getElementById('final-capital'); nextLevelButton=document.getElementById('next-level-button'); themeToggle=document.getElementById('theme-toggle'); toggleFullscreenBtn=document.getElementById('toggle-fullscreen-btn'); skipToTradingSimBtn=document.getElementById('skip-to-trading-sim-btn'); backToLearningBtn=document.getElementById('back-to-learning-btn'); skipLevelBtn=document.getElementById('skip-level-btn'); prevLevelBtn=document.getElementById('prev-level-btn'); resizer=document.getElementById('resizer'); soundCorrect=document.getElementById('sound-correct'); soundIncorrect=document.getElementById('sound-incorrect'); soundClick=document.getElementById('sound-click');

            // --- Initialize Game ---
            try {
                 if (!simulatorContainer || !feedbackArea || !termSelect) { throw new Error("Init failed: Core elements missing."); }
                 console.log("Elements assigned.");
                 const savedTheme = localStorage.getItem('theme') || 'light'; applyTheme(savedTheme); console.log(`Theme: ${savedTheme}`);
                 document.body.addEventListener('click', enableAudioOnClick, { once: true, capture: true }); document.body.addEventListener('touchstart', enableAudioOnClick, { once: true, capture: true }); console.log("Audio listeners added.");
                 initResizer(); console.log("Resizer initialized.");
                 loadLevel(currentLevel); console.log(`Level ${currentLevel} loaded.`);

                 // Add Event Listeners
                 if (toggleFullscreenBtn) { toggleFullscreenBtn.addEventListener('click', toggleFullScreen); document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); document.addEventListener('mozfullscreenchange', handleFullscreenChange); document.addEventListener('MSFullscreenChange', handleFullscreenChange); } else console.error("#toggle missing");
                 if (themeToggle) { themeToggle.addEventListener('change', () => { const theme = themeToggle.checked ? 'dark' : 'light'; localStorage.setItem('theme', theme); applyTheme(theme); playSound(soundClick); }); } else console.error("#theme missing");
                 if (submitRevealButton) { submitRevealButton.addEventListener('click', handleSubmitAndReveal); } else console.error("#submit missing");
                 if (nextChallengeButton) { nextChallengeButton.addEventListener('click', handleNextChallenge); } else console.error("#next missing");
                 if (skipToTradingSimBtn) { skipToTradingSimBtn.addEventListener('click', startTradingSimulator); } else console.error("#skip missing"); // Updated ID
                 if (backToLearningBtn) { backToLearningBtn.addEventListener('click', handleBackToLearning); } else console.error("#back missing");
                 if (skipLevelBtn) { skipLevelBtn.addEventListener('click', handleSkipLevel); } else console.error("#skip-level missing");
                 if (prevLevelBtn) { prevLevelBtn.addEventListener('click', handlePrevLevel); } else console.error("#prev-level missing");

                 console.log("--- Initialization Complete ---");
             } catch (error) {
                  console.error("CRITICAL INIT ERROR:", error);
                  document.body.innerHTML = `<div style='padding:20px;margin:20px;border:2px solid red;background:#fff0f0;color:#721c24;font-family:sans-serif;text-align:center;'><h2 style='color:red;'>Init Failed</h2><p>Error starting game.</p><p><strong>Error:</strong> ${error.message}</p><p>Check console (F12) & refresh.</p><button onclick='location.reload()' style='padding:8px 15px;cursor:pointer;'>Refresh</button></div>`;
             }
        });
    </script>

</body>
</html>
